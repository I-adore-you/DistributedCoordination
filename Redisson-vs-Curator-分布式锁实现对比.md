# Redisson vs Apache Curatorï¼šåˆ†å¸ƒå¼é”å®ç°æ·±åº¦å¯¹æ¯”

æœ¬æ–‡æ¡£è¯¦ç»†å¯¹æ¯” **Redissonï¼ˆåŸºäº Redisï¼‰** å’Œ **Apache Curatorï¼ˆåŸºäº ZooKeeperï¼‰** ä¸¤ç§åˆ†å¸ƒå¼é”æ¡†æ¶çš„å®ç°åŸç†ã€æœºåˆ¶ã€æ€§èƒ½å’Œä½¿ç”¨åœºæ™¯ã€‚

---

## ç›®å½•

1. [æ¡†æ¶æ¦‚è¿°](#1-æ¡†æ¶æ¦‚è¿°)
2. [å®ç°åŸç†å¯¹æ¯”](#2-å®ç°åŸç†å¯¹æ¯”)
3. [æ ¸å¿ƒæœºåˆ¶å¯¹æ¯”](#3-æ ¸å¿ƒæœºåˆ¶å¯¹æ¯”)
4. [ä»£ç ç¤ºä¾‹å¯¹æ¯”](#4-ä»£ç ç¤ºä¾‹å¯¹æ¯”)
5. [æ€§èƒ½å¯¹æ¯”](#5-æ€§èƒ½å¯¹æ¯”)
6. [å¯é æ€§å¯¹æ¯”](#6-å¯é æ€§å¯¹æ¯”)
7. [åŠŸèƒ½ç‰¹æ€§å¯¹æ¯”](#7-åŠŸèƒ½ç‰¹æ€§å¯¹æ¯”)
8. [ä½¿ç”¨åœºæ™¯å¯¹æ¯”](#8-ä½¿ç”¨åœºæ™¯å¯¹æ¯”)
9. [é€‰å‹å»ºè®®](#9-é€‰å‹å»ºè®®)

---

## 1. æ¡†æ¶æ¦‚è¿°

### 1.1 Redisson

**å®šä½**ï¼šåŸºäº Redis çš„ Java åˆ†å¸ƒå¼å¯¹è±¡å’ŒæœåŠ¡æ¡†æ¶

- **GitHub**: https://github.com/redisson/redisson
- **å®˜æ–¹æ–‡æ¡£**: https://github.com/redisson/redisson/wiki
- **æœ€æ–°ç‰ˆæœ¬**: 3.24+ (2024)
- **License**: Apache 2.0

**æ ¸å¿ƒç‰¹æ€§**ï¼š
- åˆ†å¸ƒå¼é”ï¼ˆå¯é‡å…¥é”ã€è¯»å†™é”ã€å…¬å¹³é”ç­‰ï¼‰
- åˆ†å¸ƒå¼é›†åˆã€é˜Ÿåˆ—ã€ä¿¡å·é‡
- åˆ†å¸ƒå¼å¯¹è±¡å’ŒæœåŠ¡
- æ”¯æŒ Redis å•æœºã€å“¨å…µã€é›†ç¾¤æ¨¡å¼

### 1.2 Apache Curator

**å®šä½**ï¼šZooKeeper çš„é«˜çº§ Java å®¢æˆ·ç«¯åº“

- **GitHub**: https://github.com/apache/curator
- **å®˜æ–¹æ–‡æ¡£**: https://curator.apache.org/
- **æœ€æ–°ç‰ˆæœ¬**: 5.5+ (2024)
- **License**: Apache 2.0

**æ ¸å¿ƒç‰¹æ€§**ï¼š
- **åˆ†å¸ƒå¼é”**ï¼šå¯é‡å…¥é”ã€è¯»å†™é”ã€ä¿¡å·é‡ã€å¤šé”ç­‰
- **é¢†å¯¼è€…é€‰ä¸¾**ï¼šLeaderSelectorã€LeaderLatchï¼ˆä¸»ä»æ¶æ„å¿…å¤‡ï¼‰
- **åˆ†å¸ƒå¼é˜Ÿåˆ—**ï¼šFIFO é˜Ÿåˆ—ã€ä¼˜å…ˆçº§é˜Ÿåˆ—ã€å»¶è¿Ÿé˜Ÿåˆ—
- **åˆ†å¸ƒå¼è®¡æ•°å™¨**ï¼šSharedCountã€DistributedAtomicLongï¼ˆç»Ÿè®¡ã€é™æµï¼‰
- **æœåŠ¡å‘ç°**ï¼šServiceDiscoveryï¼ˆå¾®æœåŠ¡æ³¨å†Œä¸å‘ç°ï¼‰
- **ç¼“å­˜**ï¼šNodeCacheã€PathChildrenCacheã€TreeCacheï¼ˆé…ç½®ç®¡ç†ã€æ•°æ®åŒæ­¥ï¼‰
- **æ …æ **ï¼šDistributedBarrierã€DistributedDoubleBarrierï¼ˆè¿›ç¨‹åè°ƒï¼‰
- **åŸå­å€¼**ï¼šDistributedAtomicLongï¼ˆåŸå­æ“ä½œï¼‰
- **äº‹åŠ¡æ”¯æŒ**ï¼šCuratorTransactionï¼ˆæ‰¹é‡åŸå­æ“ä½œï¼‰
- **æµ‹è¯•å·¥å…·**ï¼šTestingServerï¼ˆåµŒå…¥å¼ ZooKeeper æœåŠ¡å™¨ï¼‰

**è¯¦ç»†åŠŸèƒ½è¯´æ˜**ï¼šå‚è§ [Apache-Curator-åŠŸèƒ½è¯¦è§£.md](./Apache-Curator-åŠŸèƒ½è¯¦è§£.md)

---

## 2. å®ç°åŸç†å¯¹æ¯”

### 2.1 Redisson åˆ†å¸ƒå¼é”å®ç°åŸç†

#### æ ¸å¿ƒæœºåˆ¶

**1. åŠ é”æµç¨‹**

```
1. å®¢æˆ·ç«¯å°è¯•è·å–é”
   â†“
2. æ‰§è¡Œ Lua è„šæœ¬ï¼ˆåŸå­æ“ä½œï¼‰
   - æ£€æŸ¥é”æ˜¯å¦å­˜åœ¨ï¼ˆGET lock:resourceï¼‰
   - å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºé”ï¼ˆSET lock:resource uuid+threadId NX EX 30ï¼‰
   - å¦‚æœå­˜åœ¨ä¸”æ˜¯å½“å‰çº¿ç¨‹æŒæœ‰ï¼Œå¢åŠ é‡å…¥è®¡æ•°ï¼ˆHINCRBY lock:resource:count 1ï¼‰
   â†“
3. å¦‚æœè·å–æˆåŠŸï¼Œå¯åŠ¨ Watch Dogï¼ˆçœ‹é—¨ç‹—ï¼‰æœºåˆ¶
   - æ¯ 10 ç§’ï¼ˆé»˜è®¤ï¼‰æ£€æŸ¥é”æ˜¯å¦ä»è¢«æŒæœ‰
   - å¦‚æœæŒæœ‰ï¼Œè‡ªåŠ¨ç»­æœŸï¼ˆEXPIRE lock:resource 30ï¼‰
   â†“
4. æ‰§è¡Œä¸šåŠ¡é€»è¾‘
```

**2. è§£é”æµç¨‹**

```
1. å®¢æˆ·ç«¯å°è¯•é‡Šæ”¾é”
   â†“
2. æ‰§è¡Œ Lua è„šæœ¬ï¼ˆåŸå­æ“ä½œï¼‰
   - æ£€æŸ¥é”æ˜¯å¦å­˜åœ¨
   - æ£€æŸ¥é”çš„æŒæœ‰è€…æ˜¯å¦ä¸ºå½“å‰çº¿ç¨‹
   - å¦‚æœæ˜¯ï¼Œå‡å°‘é‡å…¥è®¡æ•°æˆ–åˆ é™¤é”
   â†“
3. åœæ­¢ Watch Dog æœºåˆ¶
```

**3. å…³é”® Lua è„šæœ¬**

**åŠ é”è„šæœ¬**ï¼š
```lua
-- KEYS[1] = lock:resource
-- ARGV[1] = uuid + threadId
-- ARGV[2] = è¿‡æœŸæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰

if (redis.call('exists', KEYS[1]) == 0) then
    redis.call('hset', KEYS[1], ARGV[1], 1);
    redis.call('pexpire', KEYS[1], ARGV[2]);
    return nil;
end;
if (redis.call('hexists', KEYS[1], ARGV[1]) == 1) then
    redis.call('hincrby', KEYS[1], ARGV[1], 1);
    redis.call('pexpire', KEYS[1], ARGV[2]);
    return nil;
end;
return redis.call('pttl', KEYS[1]);
```

**è§£é”è„šæœ¬**ï¼š
```lua
-- KEYS[1] = lock:resource
-- ARGV[1] = uuid + threadId
-- ARGV[2] = å‘å¸ƒæ¶ˆæ¯çš„ channel

if (redis.call('hexists', KEYS[1], ARGV[1]) == 0) then
    return nil;
end;
local counter = redis.call('hincrby', KEYS[1], ARGV[1], -1);
if (counter > 0) then
    redis.call('pexpire', KEYS[1], ARGV[2]);
    return 0;
else
    redis.call('del', KEYS[1]);
    redis.call('publish', KEYS[2], ARGV[2]);
    return 1;
end;
return nil;
```

**4. Watch Dogï¼ˆçœ‹é—¨ç‹—ï¼‰æœºåˆ¶**

```java
// Redisson å†…éƒ¨å®ç°ï¼ˆç®€åŒ–ç‰ˆï¼‰
private void scheduleExpirationRenewal(long threadId) {
    Timeout timeout = commandExecutor.getConnectionManager()
        .newTimeout(new TimerTask() {
            @Override
            public void run(Timeout timeout) throws Exception {
                // æ¯ 10 ç§’ï¼ˆlockWatchdogTimeout / 3ï¼‰ç»­æœŸä¸€æ¬¡
                RFuture<Boolean> future = renewExpirationAsync(threadId);
                future.onComplete((res, e) -> {
                    if (e != null) {
                        return;
                    }
                    if (res) {
                        // ç»­æœŸæˆåŠŸï¼Œç»§ç»­è°ƒåº¦ä¸‹ä¸€æ¬¡ç»­æœŸ
                        scheduleExpirationRenewal(threadId);
                    }
                });
            }
        }, 
        internalLockLeaseTime / 3, TimeUnit.MILLISECONDS);
}
```

**ç‰¹ç‚¹**ï¼š
- âœ… è‡ªåŠ¨ç»­æœŸï¼Œé˜²æ­¢ä¸šåŠ¡æ‰§è¡Œæ—¶é—´è¶…è¿‡é”è¿‡æœŸæ—¶é—´
- âœ… é»˜è®¤é”è¿‡æœŸæ—¶é—´ 30 ç§’ï¼Œæ¯ 10 ç§’ç»­æœŸä¸€æ¬¡
- âœ… å¯é…ç½® `lockWatchdogTimeout` å‚æ•°

### 2.2 Apache Curator åˆ†å¸ƒå¼é”å®ç°åŸç†

#### æ ¸å¿ƒæœºåˆ¶

**1. åŠ é”æµç¨‹**

```
1. å®¢æˆ·ç«¯å°è¯•è·å–é”
   â†“
2. åœ¨ ZooKeeper ä¸Šåˆ›å»ºä¸´æ—¶é¡ºåºèŠ‚ç‚¹
   - è·¯å¾„ï¼š/locks/resource-0000000001
   - ç±»å‹ï¼šEPHEMERAL_SEQUENTIALï¼ˆä¸´æ—¶é¡ºåºèŠ‚ç‚¹ï¼‰
   â†“
3. è·å–é”ç›®å½•ä¸‹çš„æ‰€æœ‰å­èŠ‚ç‚¹
   - è·å– /locks ä¸‹çš„æ‰€æœ‰å­èŠ‚ç‚¹
   - æŒ‰åºå·æ’åº
   â†“
4. åˆ¤æ–­æ˜¯å¦è·å¾—é”
   - å¦‚æœå½“å‰èŠ‚ç‚¹æ˜¯æœ€å°åºå·ï¼Œè·å¾—é”
   - å¦åˆ™ï¼Œç›‘å¬å‰ä¸€ä¸ªèŠ‚ç‚¹çš„åˆ é™¤äº‹ä»¶
   â†“
5. ç­‰å¾…å‰ä¸€ä¸ªèŠ‚ç‚¹åˆ é™¤ï¼ˆé€šè¿‡ Watch æœºåˆ¶ï¼‰
   â†“
6. é‡æ–°åˆ¤æ–­æ˜¯å¦è·å¾—é”
```

**2. è§£é”æµç¨‹**

```
1. å®¢æˆ·ç«¯å°è¯•é‡Šæ”¾é”
   â†“
2. åˆ é™¤ä¸´æ—¶é¡ºåºèŠ‚ç‚¹
   - DELETE /locks/resource-0000000001
   â†“
3. èŠ‚ç‚¹åˆ é™¤è§¦å‘ Watch äº‹ä»¶
   - ä¸‹ä¸€ä¸ªç­‰å¾…çš„å®¢æˆ·ç«¯æ”¶åˆ°é€šçŸ¥
   - é‡æ–°å°è¯•è·å–é”
```

**3. å…³é”®å®ç°ä»£ç ï¼ˆç®€åŒ–ç‰ˆï¼‰**

```java
// Curator InterProcessMutex æ ¸å¿ƒé€»è¾‘ï¼ˆç®€åŒ–ç‰ˆï¼‰
public class InterProcessMutex {
    
    private final String lockPath;
    private final CuratorFramework client;
    private final ThreadLocal<String> lockNodePath = new ThreadLocal<>();
    
    public void acquire() throws Exception {
        // 1. åˆ›å»ºä¸´æ—¶é¡ºåºèŠ‚ç‚¹
        String ourPath = client.create()
            .creatingParentContainersIfNeeded()
            .withMode(CreateMode.EPHEMERAL_SEQUENTIAL)
            .forPath(lockPath + "/lock-");
        
        lockNodePath.set(ourPath);
        
        // 2. å¾ªç¯å°è¯•è·å–é”
        boolean haveTheLock = false;
        while (!haveTheLock) {
            // 3. è·å–æ‰€æœ‰å­èŠ‚ç‚¹å¹¶æ’åº
            List<String> children = client.getChildren().forPath(lockPath);
            Collections.sort(children);
            
            // 4. åˆ¤æ–­æ˜¯å¦æ˜¯æœ€å°åºå·
            String sequenceNodeName = ourPath.substring(lockPath.length() + 1);
            int ourIndex = children.indexOf(sequenceNodeName);
            
            if (ourIndex < 0) {
                throw new IllegalStateException("èŠ‚ç‚¹ä¸å­˜åœ¨");
            }
            
            if (ourIndex == 0) {
                // 5. è·å¾—é”
                haveTheLock = true;
            } else {
                // 6. ç›‘å¬å‰ä¸€ä¸ªèŠ‚ç‚¹
                String pathToWatch = lockPath + "/" + children.get(ourIndex - 1);
                final CountDownLatch latch = new CountDownLatch(1);
                
                Watcher watcher = new Watcher() {
                    @Override
                    public void process(WatchedEvent event) {
                        if (event.getType() == Event.EventType.NodeDeleted) {
                            latch.countDown();
                        }
                    }
                };
                
                Stat stat = client.checkExists().usingWatcher(watcher).forPath(pathToWatch);
                if (stat != null) {
                    // 7. ç­‰å¾…å‰ä¸€ä¸ªèŠ‚ç‚¹åˆ é™¤
                    latch.await();
                }
            }
        }
    }
    
    public void release() throws Exception {
        String path = lockNodePath.get();
        if (path != null) {
            client.delete().forPath(path);
            lockNodePath.remove();
        }
    }
}
```

**4. å¯é‡å…¥é”å®ç°**

Curator é€šè¿‡ ThreadLocal å­˜å‚¨é”çš„æŒæœ‰ä¿¡æ¯ï¼Œæ”¯æŒåŒä¸€çº¿ç¨‹å¤šæ¬¡è·å–åŒä¸€æŠŠé”ï¼š

```java
// Curator å¯é‡å…¥é”å®ç°ï¼ˆç®€åŒ–ç‰ˆï¼‰
private final ThreadLocal<LockData> threadData = new ThreadLocal<>();

private static class LockData {
    final Thread owningThread;
    final String lockPath;
    final AtomicInteger lockCount = new AtomicInteger(1);
    
    LockData(Thread owningThread, String lockPath) {
        this.owningThread = owningThread;
        this.lockPath = lockPath;
    }
}

public void acquire() throws Exception {
    LockData lockData = threadData.get();
    if (lockData != null) {
        // é‡å…¥ï¼šå¢åŠ è®¡æ•°
        lockData.lockCount.incrementAndGet();
        return;
    }
    
    // é¦–æ¬¡è·å–é”
    String lockPath = internalLock();
    LockData newLockData = new LockData(Thread.currentThread(), lockPath);
    threadData.set(newLockData);
}
```

**ç‰¹ç‚¹**ï¼š
- âœ… åŸºäºä¸´æ—¶é¡ºåºèŠ‚ç‚¹ï¼Œå¤©ç„¶æ”¯æŒå…¬å¹³é”
- âœ… è‡ªåŠ¨é‡Šæ”¾ï¼ˆä¼šè¯è¿‡æœŸæ—¶èŠ‚ç‚¹è‡ªåŠ¨åˆ é™¤ï¼‰
- âœ… Watch æœºåˆ¶å‡å°‘è½®è¯¢å¼€é”€
- âœ… æ”¯æŒå¯é‡å…¥é”

---

## 3. æ ¸å¿ƒæœºåˆ¶å¯¹æ¯”

### 3.1 é”çš„å­˜å‚¨æ–¹å¼

| ç‰¹æ€§ | Redisson | Apache Curator |
|------|----------|----------------|
| **å­˜å‚¨ä½ç½®** | Redis Hash ç»“æ„ | ZooKeeper ä¸´æ—¶é¡ºåºèŠ‚ç‚¹ |
| **æ•°æ®ç»“æ„** | `lock:resource` â†’ `{uuid+threadId: count}` | `/locks/resource-0000000001` |
| **æŒä¹…åŒ–** | å†…å­˜å­˜å‚¨ï¼ˆå¯é…ç½®æŒä¹…åŒ–ï¼‰ | å†…å­˜å­˜å‚¨ï¼ˆäº‹åŠ¡æ—¥å¿—æŒä¹…åŒ–ï¼‰ |
| **æ•°æ®å¤§å°** | å°ï¼ˆä»…å­˜å‚¨é”ä¿¡æ¯ï¼‰ | å°ï¼ˆä»…å­˜å‚¨èŠ‚ç‚¹è·¯å¾„ï¼‰ |

### 3.2 é”çš„è·å–æœºåˆ¶

| ç‰¹æ€§ | Redisson | Apache Curator |
|------|----------|----------------|
| **è·å–æ–¹å¼** | SET NX EX + Lua è„šæœ¬ | åˆ›å»ºä¸´æ—¶é¡ºåºèŠ‚ç‚¹ + Watch |
| **åŸå­æ€§** | Lua è„šæœ¬ä¿è¯åŸå­æ€§ | ZooKeeper äº‹åŠ¡ä¿è¯åŸå­æ€§ |
| **ç­‰å¾…æœºåˆ¶** | Pub/Sub è®¢é˜…é”é‡Šæ”¾æ¶ˆæ¯ | Watch ç›‘å¬å‰ä¸€ä¸ªèŠ‚ç‚¹åˆ é™¤ |
| **å…¬å¹³æ€§** | é»˜è®¤éå…¬å¹³ï¼ˆå¯é…ç½®å…¬å¹³é”ï¼‰ | å¤©ç„¶å…¬å¹³ï¼ˆé¡ºåºèŠ‚ç‚¹ï¼‰ |

### 3.3 é”çš„é‡Šæ”¾æœºåˆ¶

| ç‰¹æ€§ | Redisson | Apache Curator |
|------|----------|----------------|
| **é‡Šæ”¾æ–¹å¼** | æ‰‹åŠ¨åˆ é™¤ + Lua è„šæœ¬ | åˆ é™¤ä¸´æ—¶èŠ‚ç‚¹ |
| **è‡ªåŠ¨é‡Šæ”¾** | ä¾èµ–è¿‡æœŸæ—¶é—´ï¼ˆéœ€ Watch Dogï¼‰ | ä¼šè¯è¿‡æœŸè‡ªåŠ¨åˆ é™¤ |
| **é‡Šæ”¾é€šçŸ¥** | Pub/Sub å‘å¸ƒæ¶ˆæ¯ | Watch äº‹ä»¶é€šçŸ¥ |
| **æ­»é”é£é™©** | ä½ï¼ˆWatch Dog ç»­æœŸï¼‰ | æä½ï¼ˆä¼šè¯æœºåˆ¶ï¼‰ |

### 3.4 å¯é‡å…¥é”å®ç°

| ç‰¹æ€§ | Redisson | Apache Curator |
|------|----------|----------------|
| **å®ç°æ–¹å¼** | Hash ç»“æ„å­˜å‚¨é‡å…¥è®¡æ•° | ThreadLocal + è®¡æ•° |
| **çº¿ç¨‹æ ‡è¯†** | UUID + ThreadId | Thread å¯¹è±¡ |
| **é‡å…¥è®¡æ•°** | Redis Hash å­—æ®µå€¼ | ThreadLocal è®¡æ•°å™¨ |
| **è·¨è¿›ç¨‹é‡å…¥** | ä¸æ”¯æŒï¼ˆåŸºäºçº¿ç¨‹ï¼‰ | ä¸æ”¯æŒï¼ˆåŸºäºçº¿ç¨‹ï¼‰ |

---

## 4. ä»£ç ç¤ºä¾‹å¯¹æ¯”

### 4.1 Redisson ä½¿ç”¨ç¤ºä¾‹

#### Maven ä¾èµ–

```xml
<dependency>
    <groupId>org.redisson</groupId>
    <artifactId>redisson</artifactId>
    <version>3.24.3</version>
</dependency>
```

#### åŸºæœ¬ä½¿ç”¨

```java
import org.redisson.Redisson;
import org.redisson.api.RLock;
import org.redisson.api.RedissonClient;
import org.redisson.config.Config;

// 1. åˆ›å»º Redisson å®¢æˆ·ç«¯
Config config = new Config();
config.useSingleServer()
    .setAddress("redis://127.0.0.1:6379")
    .setPassword("password")
    .setDatabase(0);

RedissonClient redisson = Redisson.create(config);

// 2. è·å–é”å¯¹è±¡
RLock lock = redisson.getLock("myLock");

try {
    // 3. å°è¯•åŠ é”
    // æ–¹å¼1ï¼šé˜»å¡å¼åŠ é”ï¼ˆé»˜è®¤30ç§’è¿‡æœŸï¼ŒWatch Dogè‡ªåŠ¨ç»­æœŸï¼‰
    lock.lock();
    
    // æ–¹å¼2ï¼šå°è¯•åŠ é”ï¼Œæœ€å¤šç­‰å¾…100ç§’ï¼Œé”å®šå10ç§’è‡ªåŠ¨è§£é”
    boolean res = lock.tryLock(100, 10, TimeUnit.SECONDS);
    
    // æ–¹å¼3ï¼šå°è¯•åŠ é”ï¼Œç«‹å³è¿”å›
    boolean res = lock.tryLock();
    
    if (res) {
        // 4. æ‰§è¡Œä¸šåŠ¡é€»è¾‘
        System.out.println("æ‰§è¡Œä¸šåŠ¡é€»è¾‘...");
        Thread.sleep(5000);
    }
} catch (InterruptedException e) {
    e.printStackTrace();
} finally {
    // 5. é‡Šæ”¾é”
    if (lock.isHeldByCurrentThread()) {
        lock.unlock();
    }
}

// 6. å…³é—­å®¢æˆ·ç«¯
redisson.shutdown();
```

#### å¯é‡å…¥é”ç¤ºä¾‹

```java
RLock lock = redisson.getLock("myLock");

// åŒä¸€çº¿ç¨‹å¯ä»¥å¤šæ¬¡è·å–åŒä¸€æŠŠé”
lock.lock();
try {
    System.out.println("ç¬¬ä¸€æ¬¡è·å–é”");
    
    lock.lock(); // é‡å…¥
    try {
        System.out.println("ç¬¬äºŒæ¬¡è·å–é”ï¼ˆé‡å…¥ï¼‰");
    } finally {
        lock.unlock(); // é‡Šæ”¾é‡å…¥é”
    }
} finally {
    lock.unlock(); // é‡Šæ”¾ä¸»é”
}
```

#### è¯»å†™é”ç¤ºä¾‹

```java
RReadWriteLock rwLock = redisson.getReadWriteLock("myRWLock");

// è¯»é”
RLock readLock = rwLock.readLock();
readLock.lock();
try {
    System.out.println("è¯»å–æ•°æ®...");
} finally {
    readLock.unlock();
}

// å†™é”
RLock writeLock = rwLock.writeLock();
writeLock.lock();
try {
    System.out.println("å†™å…¥æ•°æ®...");
} finally {
    writeLock.unlock();
}
```

#### å…¬å¹³é”ç¤ºä¾‹

```java
RLock fairLock = redisson.getFairLock("myFairLock");
fairLock.lock();
try {
    System.out.println("å…¬å¹³é”æ‰§è¡Œä¸šåŠ¡é€»è¾‘...");
} finally {
    fairLock.unlock();
}
```

### 4.2 Apache Curator ä½¿ç”¨ç¤ºä¾‹

#### Maven ä¾èµ–

```xml
<dependency>
    <groupId>org.apache.curator</groupId>
    <artifactId>curator-framework</artifactId>
    <version>5.5.0</version>
</dependency>
<dependency>
    <groupId>org.apache.curator</groupId>
    <artifactId>curator-recipes</artifactId>
    <version>5.5.0</version>
</dependency>
```

#### åŸºæœ¬ä½¿ç”¨

```java
import org.apache.curator.framework.CuratorFramework;
import org.apache.curator.framework.CuratorFrameworkFactory;
import org.apache.curator.framework.recipes.locks.InterProcessMutex;
import org.apache.curator.retry.ExponentialBackoffRetry;

// 1. åˆ›å»º Curator å®¢æˆ·ç«¯
CuratorFramework client = CuratorFrameworkFactory.builder()
    .connectString("127.0.0.1:2181")
    .sessionTimeoutMs(5000)
    .connectionTimeoutMs(3000)
    .retryPolicy(new ExponentialBackoffRetry(1000, 3))
    .build();

client.start();

// 2. åˆ›å»ºåˆ†å¸ƒå¼é”
InterProcessMutex lock = new InterProcessMutex(client, "/locks/myLock");

try {
    // 3. å°è¯•åŠ é”
    // æ–¹å¼1ï¼šé˜»å¡å¼åŠ é”
    lock.acquire();
    
    // æ–¹å¼2ï¼šå°è¯•åŠ é”ï¼Œæœ€å¤šç­‰å¾…100ç§’
    boolean acquired = lock.acquire(100, TimeUnit.SECONDS);
    
    if (acquired) {
        // 4. æ‰§è¡Œä¸šåŠ¡é€»è¾‘
        System.out.println("æ‰§è¡Œä¸šåŠ¡é€»è¾‘...");
        Thread.sleep(5000);
    }
} catch (Exception e) {
    e.printStackTrace();
} finally {
    // 5. é‡Šæ”¾é”
    try {
        if (lock.isAcquiredInThisProcess()) {
            lock.release();
        }
    } catch (Exception e) {
        e.printStackTrace();
    }
}

// 6. å…³é—­å®¢æˆ·ç«¯
client.close();
```

#### å¯é‡å…¥é”ç¤ºä¾‹

```java
InterProcessMutex lock = new InterProcessMutex(client, "/locks/myLock");

// åŒä¸€çº¿ç¨‹å¯ä»¥å¤šæ¬¡è·å–åŒä¸€æŠŠé”
lock.acquire();
try {
    System.out.println("ç¬¬ä¸€æ¬¡è·å–é”");
    
    lock.acquire(); // é‡å…¥
    try {
        System.out.println("ç¬¬äºŒæ¬¡è·å–é”ï¼ˆé‡å…¥ï¼‰");
    } finally {
        lock.release(); // é‡Šæ”¾é‡å…¥é”
    }
} finally {
    lock.release(); // é‡Šæ”¾ä¸»é”
}
```

#### è¯»å†™é”ç¤ºä¾‹

```java
InterProcessReadWriteLock rwLock = new InterProcessReadWriteLock(
    client, "/locks/myRWLock");

// è¯»é”
InterProcessMutex readLock = rwLock.readLock();
readLock.acquire();
try {
    System.out.println("è¯»å–æ•°æ®...");
} finally {
    readLock.release();
}

// å†™é”
InterProcessMutex writeLock = rwLock.writeLock();
writeLock.acquire();
try {
    System.out.println("å†™å…¥æ•°æ®...");
} finally {
    writeLock.release();
}
```

#### ä¿¡å·é‡ç¤ºä¾‹

```java
InterProcessSemaphoreV2 semaphore = new InterProcessSemaphoreV2(
    client, "/semaphores/mySemaphore", 10); // æœ€å¤š10ä¸ªè®¸å¯

Lease lease = semaphore.acquire();
try {
    System.out.println("è·å–åˆ°è®¸å¯ï¼Œæ‰§è¡Œä¸šåŠ¡é€»è¾‘...");
} finally {
    semaphore.returnLease(lease);
}
```

### 4.3 ä»£ç å¤æ‚åº¦å¯¹æ¯”

| æ–¹é¢ | Redisson | Apache Curator |
|------|----------|----------------|
| **API ç®€æ´æ€§** | â­â­â­â­â­ éå¸¸ç®€æ´ | â­â­â­â­ ç®€æ´ |
| **å­¦ä¹ æ›²çº¿** | â­â­â­â­â­ å®¹æ˜“ä¸Šæ‰‹ | â­â­â­â­ ç›¸å¯¹å®¹æ˜“ |
| **ä»£ç é‡** | å°‘ï¼ˆ5-10è¡Œï¼‰ | å°‘ï¼ˆ5-10è¡Œï¼‰ |
| **é…ç½®å¤æ‚åº¦** | ä½ | ä¸­ç­‰ |

---

## 5. æ€§èƒ½å¯¹æ¯”

### 5.1 å»¶è¿Ÿå¯¹æ¯”

| æ“ä½œ | Redisson | Apache Curator | è¯´æ˜ |
|------|----------|----------------|------|
| **åŠ é”å»¶è¿Ÿ** | 1-5ms | 10-50ms | Redis å†…å­˜æ“ä½œ vs ZooKeeper ç½‘ç»œ+ç£ç›˜ |
| **è§£é”å»¶è¿Ÿ** | 1-3ms | 5-20ms | Redis å†…å­˜æ“ä½œ vs ZooKeeper ç½‘ç»œ+ç£ç›˜ |
| **é”ç»­æœŸå»¶è¿Ÿ** | 1-3ms | N/A | Watch Dog æœºåˆ¶ vs æ— éœ€ç»­æœŸ |
| **ç­‰å¾…é€šçŸ¥å»¶è¿Ÿ** | 1-5ms | 5-20ms | Pub/Sub vs Watch äº‹ä»¶ |

**æ€§èƒ½å·®å¼‚åŸå› **ï¼š

1. **Redisson**ï¼š
   - Redis æ˜¯å†…å­˜æ•°æ®åº“ï¼Œæ“ä½œåœ¨å†…å­˜ä¸­å®Œæˆ
   - å•çº¿ç¨‹æ¨¡å‹ï¼Œæ— é”ç«äº‰
   - ç½‘ç»œå»¶è¿Ÿä½ï¼ˆæœ¬åœ°æˆ–å†…ç½‘ï¼‰

2. **Apache Curator**ï¼š
   - ZooKeeper éœ€è¦ Leader ç¡®è®¤å†™æ“ä½œ
   - éœ€è¦å†™å…¥äº‹åŠ¡æ—¥å¿—ï¼ˆç£ç›˜ï¼‰
   - ç½‘ç»œå»¶è¿Ÿç›¸å¯¹è¾ƒé«˜

### 5.2 ååé‡å¯¹æ¯”

| æŒ‡æ ‡ | Redisson | Apache Curator | å·®å¼‚ |
|------|----------|----------------|------|
| **QPSï¼ˆå•æœºï¼‰** | 100,000+ | 5,000-10,000 | 10-20å€ |
| **å¹¶å‘åŠ é”** | æé«˜ | ä¸­ç­‰ | Redis å•çº¿ç¨‹é«˜æ•ˆ |
| **é”ç«äº‰åœºæ™¯** | æ€§èƒ½ä¼˜ç§€ | æ€§èƒ½è‰¯å¥½ | å…¬å¹³é”æœ‰é¢å¤–å¼€é”€ |

**æµ‹è¯•åœºæ™¯**ï¼š
- 1000 ä¸ªçº¿ç¨‹åŒæ—¶ç«äº‰åŒä¸€æŠŠé”
- é”æŒæœ‰æ—¶é—´ï¼š100ms
- æµ‹è¯•æ—¶é•¿ï¼š60ç§’

**é¢„æœŸç»“æœ**ï¼š
- **Redisson**ï¼šå¯å¤„ç† 50,000+ æ¬¡åŠ é”æ“ä½œ
- **Apache Curator**ï¼šå¯å¤„ç† 3,000-5,000 æ¬¡åŠ é”æ“ä½œ

### 5.3 èµ„æºæ¶ˆè€—å¯¹æ¯”

| èµ„æº | Redisson | Apache Curator | è¯´æ˜ |
|------|----------|----------------|------|
| **CPU** | ä½ | ä¸­ç­‰ | Redis å•çº¿ç¨‹ vs ZooKeeper å¤šçº¿ç¨‹ |
| **å†…å­˜** | ä½ | ä¸­ç­‰ | Redis å†…å­˜å ç”¨ vs ZooKeeper å†…å­˜+ç£ç›˜ |
| **ç½‘ç»œ** | ä½ | ä¸­ç­‰ | Redis ç®€å•åè®® vs ZooKeeper å¤æ‚åè®® |
| **ç£ç›˜ I/O** | æ— ï¼ˆå¯é…ç½®ï¼‰ | æœ‰ï¼ˆäº‹åŠ¡æ—¥å¿—ï¼‰ | Redis å¯é€‰æŒä¹…åŒ– vs ZooKeeper å¿…é¡»æŒä¹…åŒ– |

### 5.4 æ€§èƒ½æ€»ç»“

| ç»´åº¦ | Redisson | Apache Curator | èƒœè€… |
|------|----------|----------------|------|
| **å»¶è¿Ÿ** | â­â­â­â­â­ | â­â­â­ | Redisson |
| **ååé‡** | â­â­â­â­â­ | â­â­â­ | Redisson |
| **èµ„æºæ¶ˆè€—** | â­â­â­â­â­ | â­â­â­â­ | Redisson |
| **æ€§èƒ½ç¨³å®šæ€§** | â­â­â­â­ | â­â­â­â­â­ | Curator |

**ç»“è®º**ï¼šRedisson åœ¨æ€§èƒ½æ–¹é¢å…¨é¢é¢†å…ˆï¼Œé€‚åˆé«˜å¹¶å‘åœºæ™¯ã€‚

---

## 6. å¯é æ€§å¯¹æ¯”

### 6.1 ä¸€è‡´æ€§ä¿è¯

| ç‰¹æ€§ | Redisson | Apache Curator | è¯´æ˜ |
|------|----------|----------------|------|
| **ä¸€è‡´æ€§æ¨¡å‹** | æœ€ç»ˆä¸€è‡´æ€§ | å¼ºä¸€è‡´æ€§ | Redis AP vs ZooKeeper CP |
| **æ•°æ®ä¸€è‡´æ€§** | ä¸»ä»å»¶è¿Ÿ | å¼ºä¸€è‡´æ€§ | Redis ä¸»ä»å¤åˆ¶å»¶è¿Ÿ |
| **é”ä¸¢å¤±é£é™©** | ä¸­ç­‰ï¼ˆä¸»ä»åˆ‡æ¢ï¼‰ | æä½ | Redis æ•…éšœè½¬ç§»å¯èƒ½ä¸¢é” |
| **è„‘è£‚é—®é¢˜** | å¯èƒ½å‘ç”Ÿ | ä¸ä¼šå‘ç”Ÿ | Redis é›†ç¾¤è„‘è£‚ vs ZooKeeper ä¸€è‡´æ€§åè®® |

### 6.2 é«˜å¯ç”¨æ€§

#### Redisson é«˜å¯ç”¨æ–¹æ¡ˆ

**1. å•æœºæ¨¡å¼**
```
Redis å•æœº
  â†“
é—®é¢˜ï¼šå•ç‚¹æ•…éšœ
è§£å†³ï¼šæ— ï¼ˆä¸æ¨èç”Ÿäº§ç¯å¢ƒï¼‰
```

**2. ä¸»ä»æ¨¡å¼ï¼ˆSentinelï¼‰**
```
Redis Master â†â†’ Redis Slave
     â†“
Sentinel ç›‘æ§
  â†“
é—®é¢˜ï¼šä¸»ä»åˆ‡æ¢æ—¶å¯èƒ½ä¸¢é”
è§£å†³ï¼šRedLock ç®—æ³•ï¼ˆå¤šå®ä¾‹ï¼‰
```

**3. é›†ç¾¤æ¨¡å¼ï¼ˆClusterï¼‰**
```
Redis Cluster (3ä¸»3ä»)
  â†“
æ•°æ®åˆ†ç‰‡å­˜å‚¨ï¼Œæ¯ä¸ªåˆ†ç‰‡æœ‰ä¸»ä»å‰¯æœ¬
  â†“
è‡ªåŠ¨æ•…éšœè½¬ç§»
  â†“
é—®é¢˜ï¼šå•ä¸ªåˆ†ç‰‡ä¸»ä»åˆ‡æ¢æ—¶å¯èƒ½ä¸¢é”
å½±å“ï¼šä»…å½±å“è¯¥åˆ†ç‰‡çš„é”ï¼Œå½±å“èŒƒå›´æœ‰é™
è§£å†³ï¼šå¤§å¤šæ•°æƒ…å†µä¸‹ä¸éœ€è¦ RedLockï¼ˆè¯¦è§ 12.8 èŠ‚ï¼‰
```

**4. RedLock ç®—æ³•**
```
åœ¨å¤šä¸ªç‹¬ç«‹çš„ Redis å®ä¾‹ä¸Šè·å–é”
  â†“
è¦æ±‚ï¼šN/2 + 1 ä¸ªå®ä¾‹æˆåŠŸ
  â†“
æ³¨æ„ï¼šéœ€è¦é¢å¤–éƒ¨ç½²ç‹¬ç«‹çš„ Redis å®ä¾‹
     ï¼ˆä¸èƒ½ä½¿ç”¨ Cluster çš„ master èŠ‚ç‚¹ï¼‰
  â†“
ä¼˜ç‚¹ï¼šæé«˜å¯é æ€§
ç¼ºç‚¹ï¼šæ€§èƒ½ä¸‹é™ï¼Œå®ç°å¤æ‚ï¼Œæˆæœ¬é«˜
```

**é‡è¦è¯´æ˜**ï¼š
- âš ï¸ Redis Cluster çš„ master èŠ‚ç‚¹ä¸èƒ½ç”¨äº RedLock
- âš ï¸ RedLock éœ€è¦ç‹¬ç«‹çš„ Redis å®ä¾‹ï¼ˆå•æœºæˆ–ä¸»ä»ï¼‰
- âš ï¸ å¦‚æœä½¿ç”¨ RedLockï¼Œéœ€è¦é¢å¤–éƒ¨ç½² 3-5 ä¸ªç‹¬ç«‹çš„ Redis å®ä¾‹

#### Apache Curator é«˜å¯ç”¨æ–¹æ¡ˆ

**1. ZooKeeper é›†ç¾¤**
```
ZooKeeper Cluster (3èŠ‚ç‚¹æˆ–5èŠ‚ç‚¹)
  â†“
Leader + Followers
  â†“
ZAB åè®®ä¿è¯ä¸€è‡´æ€§
  â†“
ä¼˜ç‚¹ï¼šå¼ºä¸€è‡´æ€§ï¼Œè‡ªåŠ¨æ•…éšœè½¬ç§»
ç¼ºç‚¹ï¼šéœ€è¦å¤šæ•°èŠ‚ç‚¹å¯ç”¨
```

**2. æ•…éšœè½¬ç§»**
```
Leader æ•…éšœ
  â†“
è‡ªåŠ¨é€‰ä¸¾æ–° Leader
  â†“
å®¢æˆ·ç«¯è‡ªåŠ¨é‡è¿
  â†“
é”çŠ¶æ€ä¿æŒä¸€è‡´
```

### 6.3 é”çš„è‡ªåŠ¨é‡Šæ”¾

| ç‰¹æ€§ | Redisson | Apache Curator |
|------|----------|----------------|
| **è‡ªåŠ¨é‡Šæ”¾æœºåˆ¶** | Watch Dog ç»­æœŸ | ä¼šè¯è¿‡æœŸè‡ªåŠ¨åˆ é™¤ |
| **å®¢æˆ·ç«¯å´©æºƒ** | ä¾èµ–è¿‡æœŸæ—¶é—´ | ä¼šè¯æ–­å¼€è‡ªåŠ¨åˆ é™¤ |
| **ç½‘ç»œåˆ†åŒº** | å¯èƒ½è¯¯é‡Šæ”¾ | ä¼šè¯è¶…æ—¶è‡ªåŠ¨åˆ é™¤ |
| **æ­»é”é£é™©** | æä½ | æä½ |

**Redisson Watch Dog æœºåˆ¶**ï¼š
- âœ… è‡ªåŠ¨ç»­æœŸï¼Œé˜²æ­¢ä¸šåŠ¡æ‰§è¡Œæ—¶é—´è¶…è¿‡é”è¿‡æœŸæ—¶é—´
- âš ï¸ å¦‚æœå®¢æˆ·ç«¯å´©æºƒï¼ŒWatch Dog åœæ­¢ï¼Œé”ä¼šåœ¨è¿‡æœŸæ—¶é—´åé‡Šæ”¾
- âš ï¸ å¦‚æœç½‘ç»œåˆ†åŒºï¼ŒWatch Dog æ— æ³•ç»­æœŸï¼Œé”å¯èƒ½è¢«è¯¯é‡Šæ”¾

**Apache Curator ä¼šè¯æœºåˆ¶**ï¼š
- âœ… å®¢æˆ·ç«¯å´©æºƒæ—¶ï¼Œä¼šè¯æ–­å¼€ï¼Œä¸´æ—¶èŠ‚ç‚¹è‡ªåŠ¨åˆ é™¤
- âœ… ç½‘ç»œåˆ†åŒºæ—¶ï¼Œä¼šè¯è¶…æ—¶ï¼Œä¸´æ—¶èŠ‚ç‚¹è‡ªåŠ¨åˆ é™¤
- âœ… æ— éœ€è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œæ›´å¯é 

### 6.4 ä¸»ä»åˆ‡æ¢åœºæ™¯æ·±åº¦åˆ†æ

#### 6.4.1 Redisson ä¸»ä»åˆ‡æ¢é—®é¢˜è¯¦è§£

**é—®é¢˜åœºæ™¯**ï¼š

```
æ—¶é—´çº¿ï¼š
T1: å®¢æˆ·ç«¯ A åœ¨ Redis Master ä¸ŠæˆåŠŸè·å–é”
    â†“
T2: Redis Master å°†é”ä¿¡æ¯å¼‚æ­¥å¤åˆ¶åˆ° Slaveï¼ˆå¯èƒ½å»¶è¿Ÿï¼‰
    â†“
T3: Redis Master çªç„¶å®•æœºï¼ˆé”ä¿¡æ¯å¯èƒ½è¿˜æœªåŒæ­¥åˆ° Slaveï¼‰
    â†“
T4: Sentinel å°† Slave æå‡ä¸ºæ–°çš„ Master
    â†“
T5: å®¢æˆ·ç«¯ B åœ¨æ–°çš„ Master ä¸Šå‘ç°é”ä¸å­˜åœ¨ï¼ŒæˆåŠŸè·å–é”
    â†“
âŒ é—®é¢˜ï¼šå®¢æˆ·ç«¯ A å’Œ B åŒæ—¶æŒæœ‰é”ï¼Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ï¼
```

**é—®é¢˜æ ¹æº**ï¼š

1. **Redis ä¸»ä»å¤åˆ¶æ˜¯å¼‚æ­¥çš„**
   - Master å†™å…¥åç«‹å³è¿”å›æˆåŠŸ
   - æ•°æ®å¼‚æ­¥å¤åˆ¶åˆ° Slaveï¼Œå­˜åœ¨å»¶è¿Ÿ
   - å¦‚æœ Master åœ¨å¤åˆ¶å®Œæˆå‰å®•æœºï¼Œæ•°æ®å¯èƒ½ä¸¢å¤±

2. **æ•…éšœè½¬ç§»æ—¶é—´çª—å£**
   - ä¸»ä»åˆ‡æ¢éœ€è¦æ—¶é—´ï¼ˆé€šå¸¸å‡ ç§’åˆ°å‡ åç§’ï¼‰
   - åœ¨è¿™ä¸ªæ—¶é—´çª—å£å†…ï¼Œé”çŠ¶æ€å¯èƒ½ä¸ä¸€è‡´

3. **å®é™…æ¡ˆä¾‹**ï¼š

```java
// å®¢æˆ·ç«¯ A
RLock lockA = redisson.getLock("resource");
lockA.lock(); // åœ¨ Master ä¸ŠæˆåŠŸè·å–é”
try {
    // æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼ˆå‡è®¾éœ€è¦ 10 ç§’ï¼‰
    doBusinessLogic();
} finally {
    lockA.unlock();
}

// å¦‚æœ Master åœ¨ç¬¬ 5 ç§’æ—¶å®•æœºï¼Œä¸”é”ä¿¡æ¯æœªåŒæ­¥åˆ° Slave
// å®¢æˆ·ç«¯ B å¯èƒ½åœ¨æ–° Master ä¸Šè·å–åˆ°åŒä¸€æŠŠé”
// å¯¼è‡´å®¢æˆ·ç«¯ A å’Œ B åŒæ—¶æ‰§è¡Œï¼Œæ•°æ®ä¸ä¸€è‡´ï¼
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

#### æ–¹æ¡ˆ1ï¼šRedLock ç®—æ³•ï¼ˆæ¨èï¼‰

**åŸç†**ï¼šåœ¨å¤šä¸ªç‹¬ç«‹çš„ Redis å®ä¾‹ä¸ŠåŒæ—¶è·å–é”ï¼Œåªæœ‰å¤§å¤šæ•°å®ä¾‹æˆåŠŸæ‰è®¤ä¸ºè·å–æˆåŠŸã€‚

**å®ç°**ï¼š

```java
// Redisson RedLock ä½¿ç”¨ç¤ºä¾‹
Config config1 = new Config();
config1.useSingleServer().setAddress("redis://127.0.0.1:6379");
RedissonClient redisson1 = Redisson.create(config1);

Config config2 = new Config();
config2.useSingleServer().setAddress("redis://127.0.0.1:6380");
RedissonClient redisson2 = Redisson.create(config2);

Config config3 = new Config();
config3.useSingleServer().setAddress("redis://127.0.0.1:6381");
RedissonClient redisson3 = Redisson.create(config3);

// åˆ›å»º RedLock
RLock lock1 = redisson1.getLock("myLock");
RLock lock2 = redisson2.getLock("myLock");
RLock lock3 = redisson3.getLock("myLock");

RedissonRedLock redLock = new RedissonRedLock(lock1, lock2, lock3);

try {
    // åœ¨å¤§å¤šæ•°å®ä¾‹ä¸Šè·å–é”ï¼ˆè‡³å°‘ 2/3 æˆåŠŸï¼‰
    boolean res = redLock.tryLock(100, 10, TimeUnit.SECONDS);
    if (res) {
        // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
        doBusinessLogic();
    }
} finally {
    redLock.unlock();
}
```

**RedLock ç®—æ³•æµç¨‹**ï¼š

```
1. å®¢æˆ·ç«¯è·å–å½“å‰æ—¶é—´ T1
   â†“
2. ä¾æ¬¡åœ¨ N ä¸ªç‹¬ç«‹çš„ Redis å®ä¾‹ä¸Šå°è¯•è·å–é”
   - æ¯ä¸ªå®ä¾‹è®¾ç½®ç›¸åŒçš„ key å’Œ value
   - è®¾ç½®ç›¸åŒçš„è¿‡æœŸæ—¶é—´ï¼ˆå¦‚ 30 ç§’ï¼‰
   â†“
3. è®¡ç®—è·å–é”çš„æ€»è€—æ—¶ T2 = å½“å‰æ—¶é—´ - T1
   â†“
4. åˆ¤æ–­æ˜¯å¦æˆåŠŸï¼š
   - å¦‚æœæˆåŠŸè·å–é”çš„å®ä¾‹æ•° >= N/2 + 1
   - ä¸” T2 < é”çš„æœ‰æ•ˆæ—¶é—´ï¼ˆå¦‚ 30 ç§’ï¼‰
   - åˆ™è®¤ä¸ºè·å–é”æˆåŠŸ
   â†“
5. å¦‚æœå¤±è´¥ï¼Œé‡Šæ”¾æ‰€æœ‰å·²è·å–çš„é”
```

**RedLock ä¼˜åŠ¿**ï¼š

- âœ… å³ä½¿éƒ¨åˆ† Redis å®ä¾‹æ•…éšœï¼Œåªè¦å¤§å¤šæ•°å®ä¾‹å¯ç”¨ï¼Œé”ä»ç„¶æœ‰æ•ˆ
- âœ… å³ä½¿æŸä¸ªå®ä¾‹ä¸»ä»åˆ‡æ¢ä¸¢å¤±é”ï¼Œå…¶ä»–å®ä¾‹ä»æŒæœ‰é”
- âœ… æé«˜äº†é”çš„å¯é æ€§

**RedLock é™åˆ¶**ï¼š

- âš ï¸ **æ€§èƒ½ä¸‹é™**ï¼šéœ€è¦ä¸å¤šä¸ªå®ä¾‹é€šä¿¡ï¼Œå»¶è¿Ÿå¢åŠ 
- âš ï¸ **æˆæœ¬å¢åŠ **ï¼šéœ€è¦ç»´æŠ¤å¤šä¸ªç‹¬ç«‹çš„ Redis å®ä¾‹
- âš ï¸ **æ—¶é’ŸåŒæ­¥è¦æ±‚**ï¼šéœ€è¦ç¡®ä¿æ‰€æœ‰ Redis å®ä¾‹æ—¶é’ŸåŒæ­¥
- âš ï¸ **ä»éå®Œç¾**ï¼šåœ¨æç«¯ç½‘ç»œåˆ†åŒºæƒ…å†µä¸‹ï¼Œä»å¯èƒ½å‡ºç°é—®é¢˜

**RedLock äº‰è®®**ï¼š

Martin Kleppmannï¼ˆã€Šæ•°æ®å¯†é›†å‹åº”ç”¨ç³»ç»Ÿè®¾è®¡ã€‹ä½œè€…ï¼‰æ›¾è´¨ç–‘ RedLock ç®—æ³•çš„æ­£ç¡®æ€§ï¼Œè®¤ä¸ºï¼š
- åœ¨æ—¶é’Ÿæ¼‚ç§»çš„æƒ…å†µä¸‹å¯èƒ½å¤±æ•ˆ
- åœ¨ GC æš‚åœçš„æƒ…å†µä¸‹å¯èƒ½å¤±æ•ˆ
- éœ€è¦é¢å¤–çš„ fencing token æœºåˆ¶

ä½† Redis ä½œè€… Antirez è¿›è¡Œäº†åé©³ï¼Œè®¤ä¸ºï¼š
- RedLock åœ¨å¤§å¤šæ•°å®é™…åœºæ™¯ä¸‹æ˜¯å¯é çš„
- éœ€è¦é…åˆåˆç†çš„è¿‡æœŸæ—¶é—´è®¾ç½®
- å¯¹äºå¤§å¤šæ•°ä¸šåŠ¡åœºæ™¯å·²ç»è¶³å¤Ÿ

#### æ–¹æ¡ˆ2ï¼šRedis Cluster æ¨¡å¼

**åŸç†**ï¼šä½¿ç”¨ Redis Clusterï¼Œæ•°æ®åˆ†ç‰‡å­˜å‚¨ï¼Œæ¯ä¸ªåˆ†ç‰‡æœ‰ä¸»ä»å‰¯æœ¬ã€‚

**ä¼˜åŠ¿**ï¼š
- âœ… è‡ªåŠ¨æ•…éšœè½¬ç§»
- âœ… æ•°æ®åˆ†ç‰‡ï¼Œæé«˜æ€§èƒ½
- âœ… å†…ç½®é«˜å¯ç”¨

**é™åˆ¶**ï¼š
- âš ï¸ å•ä¸ªåˆ†ç‰‡çš„ä¸»ä»åˆ‡æ¢ä»å¯èƒ½ä¸¢é”
- âš ï¸ éœ€è¦é…åˆ RedLock ä½¿ç”¨æ‰èƒ½å®Œå…¨é¿å…é—®é¢˜

#### æ–¹æ¡ˆ3ï¼šç­‰å¾…å¤åˆ¶ç¡®è®¤ï¼ˆWAIT å‘½ä»¤ï¼‰

**åŸç†**ï¼šä½¿ç”¨ Redis WAIT å‘½ä»¤ç­‰å¾…æ•°æ®å¤åˆ¶åˆ°æŒ‡å®šæ•°é‡çš„ä»èŠ‚ç‚¹ã€‚

**å®ç°**ï¼ˆä¸æ¨èï¼ŒRedisson ä¸æ”¯æŒï¼‰ï¼š

```bash
# Redis å‘½ä»¤ç¤ºä¾‹ï¼ˆRedisson ä¸æ”¯æŒï¼‰
SET lock:resource "value" NX EX 30
WAIT 1 1000  # ç­‰å¾…è‡³å°‘ 1 ä¸ªä»èŠ‚ç‚¹ç¡®è®¤ï¼Œè¶…æ—¶ 1000ms
```

**é™åˆ¶**ï¼š
- âš ï¸ Redisson ä¸æ”¯æŒæ­¤åŠŸèƒ½
- âš ï¸ æ€§èƒ½ä¸‹é™æ˜æ˜¾
- âš ï¸ å¦‚æœä»èŠ‚ç‚¹æ•°é‡ä¸è¶³ï¼Œä¼šé˜»å¡

#### æ–¹æ¡ˆ4ï¼šä¸šåŠ¡å±‚è¡¥å¿æœºåˆ¶

**åŸç†**ï¼šåœ¨ä¸šåŠ¡å±‚å¢åŠ å¹‚ç­‰æ€§æ£€æŸ¥å’Œè¡¥å¿é€»è¾‘ã€‚

**å®ç°**ï¼š

```java
RLock lock = redisson.getLock("resource");
try {
    if (lock.tryLock()) {
        // æ‰§è¡Œä¸šåŠ¡é€»è¾‘å‰ï¼Œå…ˆæ£€æŸ¥æ˜¯å¦å·²æ‰§è¡Œ
        String idempotentKey = "business:" + businessId;
        if (!redis.exists(idempotentKey)) {
            // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
            doBusinessLogic();
            // è®¾ç½®å¹‚ç­‰æ€§æ ‡è®°
            redis.setex(idempotentKey, 3600, "done");
        }
    }
} finally {
    lock.unlock();
}
```

**ä¼˜åŠ¿**ï¼š
- âœ… å³ä½¿é”å¤±æ•ˆï¼Œä¸šåŠ¡å±‚ä¹Ÿèƒ½ä¿è¯å¹‚ç­‰æ€§
- âœ… é€‚åˆå¯¹ä¸€è‡´æ€§è¦æ±‚ä¸æ˜¯ç‰¹åˆ«ä¸¥æ ¼çš„åœºæ™¯

**é™åˆ¶**ï¼š
- âš ï¸ éœ€è¦ä¸šåŠ¡å±‚é…åˆ
- âš ï¸ å¢åŠ äº†ç³»ç»Ÿå¤æ‚åº¦

#### 6.4.2 ZooKeeper ä¸»ä»åˆ‡æ¢é—®é¢˜åˆ†æ

**å…³é”®é—®é¢˜ï¼šZooKeeper ä¼šå‡ºç°åŒæ ·çš„é—®é¢˜å—ï¼Ÿ**

**ç­”æ¡ˆï¼šä¸ä¼šï¼ZooKeeper é€šè¿‡ ZAB åè®®é¿å…äº†è¿™ä¸ªé—®é¢˜ã€‚**

**ZooKeeper çš„è§£å†³æ–¹æ¡ˆ**ï¼š

#### 1. ZAB åè®®ä¿è¯å¼ºä¸€è‡´æ€§

**ZABï¼ˆZooKeeper Atomic Broadcastï¼‰åè®®æµç¨‹**ï¼š

```
1. å®¢æˆ·ç«¯è¯·æ±‚å†™å…¥æ“ä½œ
   â†“
2. Leader æ¥æ”¶è¯·æ±‚ï¼Œç”Ÿæˆäº‹åŠ¡ææ¡ˆï¼ˆProposalï¼‰
   â†“
3. Leader å°†ææ¡ˆå‘é€ç»™æ‰€æœ‰ Follower
   â†“
4. Follower æ”¶åˆ°ææ¡ˆåï¼Œå†™å…¥äº‹åŠ¡æ—¥å¿—ï¼Œè¿”å› ACK
   â†“
5. Leader æ”¶åˆ°å¤§å¤šæ•° Follower çš„ ACK å
   â†“
6. Leader æäº¤äº‹åŠ¡ï¼Œé€šçŸ¥æ‰€æœ‰ Follower æäº¤
   â†“
7. Leader è¿”å›æˆåŠŸç»™å®¢æˆ·ç«¯
```

**å…³é”®ç‚¹**ï¼š

- âœ… **åŒæ­¥å¤åˆ¶**ï¼šLeader å¿…é¡»ç­‰å¾…å¤§å¤šæ•° Follower ç¡®è®¤åæ‰è¿”å›æˆåŠŸ
- âœ… **å¼ºä¸€è‡´æ€§**ï¼šæ‰€æœ‰èŠ‚ç‚¹çœ‹åˆ°çš„æ•°æ®æ˜¯ä¸€è‡´çš„
- âœ… **ä¸ä¼šä¸¢å¤±æ•°æ®**ï¼šå³ä½¿ Leader å®•æœºï¼Œæ•°æ®å·²ç»åœ¨å¤§å¤šæ•°èŠ‚ç‚¹ä¸Š

#### 2. Leader æ•…éšœè½¬ç§»æµç¨‹

```
æ—¶é—´çº¿ï¼š
T1: å®¢æˆ·ç«¯åœ¨ Leader ä¸Šåˆ›å»ºä¸´æ—¶é¡ºåºèŠ‚ç‚¹ï¼ˆè·å–é”ï¼‰
    â†“
T2: Leader å°†æ“ä½œåŒæ­¥åˆ°å¤§å¤šæ•° Followerï¼ˆè‡³å°‘ N/2 + 1ï¼‰
    â†“
T3: Leader è¿”å›æˆåŠŸç»™å®¢æˆ·ç«¯
    â†“
T4: Leader çªç„¶å®•æœº
    â†“
T5: Follower æ£€æµ‹åˆ° Leader å®•æœºï¼Œå¼€å§‹é€‰ä¸¾
    â†“
T6: é€‰ä¸¾å‡ºæ–°çš„ Leaderï¼ˆæ•°æ®å·²ç»åŒæ­¥ï¼‰
    â†“
T7: å®¢æˆ·ç«¯è‡ªåŠ¨é‡è¿åˆ°æ–° Leader
    â†“
âœ… é”çŠ¶æ€ä¿æŒä¸€è‡´ï¼Œä¸ä¼šä¸¢å¤±ï¼
```

**ä¸ºä»€ä¹ˆä¸ä¼šä¸¢é”ï¼Ÿ**ï¼š

1. **åŒæ­¥å¤åˆ¶æœºåˆ¶**
   - ZooKeeper ä½¿ç”¨åŒæ­¥å¤åˆ¶ï¼Œä¸æ˜¯å¼‚æ­¥å¤åˆ¶
   - Leader å¿…é¡»ç­‰å¾…å¤§å¤šæ•°èŠ‚ç‚¹ç¡®è®¤åæ‰è¿”å›æˆåŠŸ
   - æ•°æ®å·²ç»åœ¨å¤§å¤šæ•°èŠ‚ç‚¹ä¸Šï¼Œä¸ä¼šä¸¢å¤±

2. **ä¸´æ—¶èŠ‚ç‚¹ç‰¹æ€§**
   - é”èŠ‚ç‚¹æ˜¯ä¸´æ—¶èŠ‚ç‚¹ï¼ˆEPHEMERALï¼‰
   - èŠ‚ç‚¹ä¿¡æ¯å­˜å‚¨åœ¨å¤§å¤šæ•°èŠ‚ç‚¹ä¸Š
   - å³ä½¿ Leader å®•æœºï¼ŒèŠ‚ç‚¹ä¿¡æ¯ä»ç„¶å­˜åœ¨

3. **é€‰ä¸¾æœºåˆ¶**
   - æ–° Leader é€‰ä¸¾æ—¶ï¼Œä¼šåŒæ­¥æ‰€æœ‰å·²æäº¤çš„äº‹åŠ¡
   - é”èŠ‚ç‚¹çš„çŠ¶æ€ä¼šè¢«å®Œæ•´ä¿ç•™
   - å®¢æˆ·ç«¯é‡è¿åï¼Œé”çŠ¶æ€ä¸€è‡´

#### 3. å®é™…å¯¹æ¯”ç¤ºä¾‹

**Redis ä¸»ä»åˆ‡æ¢åœºæ™¯**ï¼š

```
å®¢æˆ·ç«¯ A è·å–é”ï¼š
  Master: SET lock:resource "A" NX EX 30  âœ… æˆåŠŸ
  Slave:  (å¼‚æ­¥å¤åˆ¶ï¼Œå¯èƒ½è¿˜æœªåŒæ­¥)
  
Master å®•æœºï¼š
  Master: âŒ å®•æœº
  Slave:  (é”ä¿¡æ¯å¯èƒ½ä¸¢å¤±)
  
æ–° Masterï¼ˆåŸ Slaveï¼‰ï¼š
  å®¢æˆ·ç«¯ B: SET lock:resource "B" NX EX 30  âœ… æˆåŠŸï¼ˆé”ä¸å­˜åœ¨ï¼‰
  
ç»“æœï¼šå®¢æˆ·ç«¯ A å’Œ B åŒæ—¶æŒæœ‰é” âŒ
```

**ZooKeeper Leader åˆ‡æ¢åœºæ™¯**ï¼š

```
å®¢æˆ·ç«¯ A è·å–é”ï¼š
  Leader: åˆ›å»º /locks/resource-0000000001  âœ…
  Follower1: åŒæ­¥æ•°æ® âœ…
  Follower2: åŒæ­¥æ•°æ® âœ…
  Leader: æ”¶åˆ°å¤§å¤šæ•°ç¡®è®¤ï¼Œè¿”å›æˆåŠŸ âœ…
  
Leader å®•æœºï¼š
  Leader: âŒ å®•æœº
  Follower1: æ•°æ®å·²å­˜åœ¨ âœ…
  Follower2: æ•°æ®å·²å­˜åœ¨ âœ…
  
æ–° Leader é€‰ä¸¾ï¼š
  æ–° Leader: åŒæ­¥æ‰€æœ‰æ•°æ®ï¼ŒåŒ…å«é”èŠ‚ç‚¹ âœ…
  
å®¢æˆ·ç«¯ B å°è¯•è·å–é”ï¼š
  æ–° Leader: æ£€æŸ¥é”ç›®å½•ï¼Œå‘ç° resource-0000000001 å­˜åœ¨ âœ…
  å®¢æˆ·ç«¯ B: ç­‰å¾…å‰ä¸€ä¸ªèŠ‚ç‚¹åˆ é™¤ â³
  
ç»“æœï¼šé”çŠ¶æ€ä¸€è‡´ï¼Œä¸ä¼šå‡ºç°é‡å¤è·å– âœ…
```

#### 4. ZooKeeper çš„å±€é™æ€§

è™½ç„¶ ZooKeeper é¿å…äº†ä¸»ä»åˆ‡æ¢ä¸¢é”çš„é—®é¢˜ï¼Œä½†ä»æœ‰ä¸€äº›é™åˆ¶ï¼š

**é€‰ä¸¾æœŸé—´ä¸å¯ç”¨**ï¼š

```
Leader å®•æœº
  â†“
å¼€å§‹é€‰ä¸¾ï¼ˆé€šå¸¸å‡ ç§’åˆ°å‡ åç§’ï¼‰
  â†“
é€‰ä¸¾æœŸé—´ï¼Œé›†ç¾¤ä¸å¯ç”¨
  â†“
å®¢æˆ·ç«¯è¯·æ±‚ä¼šå¤±è´¥æˆ–é˜»å¡
  â†“
é€‰ä¸¾å®Œæˆåï¼ŒæœåŠ¡æ¢å¤
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- âœ… å®¢æˆ·ç«¯éœ€è¦å®ç°é‡è¯•æœºåˆ¶
- âœ… ä½¿ç”¨ Curator æ¡†æ¶ï¼Œè‡ªåŠ¨å¤„ç†é‡è¿å’Œé‡è¯•
- âœ… è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´

**ç½‘ç»œåˆ†åŒºé—®é¢˜**ï¼š

```
ç½‘ç»œåˆ†åŒºå¯¼è‡´é›†ç¾¤åˆ†è£‚ï¼š
  - åˆ†åŒº A: 2 ä¸ªèŠ‚ç‚¹ï¼ˆåŒ…å«åŸ Leaderï¼‰
  - åˆ†åŒº B: 1 ä¸ªèŠ‚ç‚¹
  
åˆ†åŒº A: å¯ä»¥ç»§ç»­æœåŠ¡ï¼ˆå¤§å¤šæ•°èŠ‚ç‚¹ï¼‰
åˆ†åŒº B: åœæ­¢æœåŠ¡ï¼ˆå°‘æ•°èŠ‚ç‚¹ï¼‰

å®¢æˆ·ç«¯åœ¨åˆ†åŒº B: æ— æ³•è·å–é”ï¼ˆæœåŠ¡ä¸å¯ç”¨ï¼‰
å®¢æˆ·ç«¯åœ¨åˆ†åŒº A: å¯ä»¥æ­£å¸¸è·å–é”
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- âœ… ZooKeeper ä¿è¯åªæœ‰å¤§å¤šæ•°èŠ‚ç‚¹çš„åˆ†åŒºæ‰èƒ½æä¾›æœåŠ¡
- âœ… é¿å…äº†è„‘è£‚é—®é¢˜
- âœ… ä¿è¯äº†æ•°æ®ä¸€è‡´æ€§

### 6.5 å¯é æ€§æ€»ç»“

| ç»´åº¦ | Redisson | Apache Curator | èƒœè€… |
|------|----------|----------------|------|
| **ä¸€è‡´æ€§** | â­â­â­ | â­â­â­â­â­ | Curator |
| **å¯ç”¨æ€§** | â­â­â­â­ | â­â­â­â­â­ | Curator |
| **æ•…éšœæ¢å¤** | â­â­â­ | â­â­â­â­â­ | Curator |
| **é”ä¸¢å¤±é£é™©** | â­â­â­ | â­â­â­â­â­ | Curator |
| **ä¸»ä»åˆ‡æ¢ä¸¢é”** | âš ï¸ å¯èƒ½å‘ç”Ÿ | âœ… ä¸ä¼šå‘ç”Ÿ | Curator |

**ä¸»ä»åˆ‡æ¢åœºæ™¯å¯¹æ¯”æ€»ç»“**ï¼š

| åœºæ™¯ | Redisson | Apache Curator |
|------|----------|----------------|
| **ä¸»ä»åˆ‡æ¢ä¸¢é”** | âš ï¸ å¯èƒ½å‘ç”Ÿï¼ˆå¼‚æ­¥å¤åˆ¶ï¼‰ | âœ… ä¸ä¼šå‘ç”Ÿï¼ˆåŒæ­¥å¤åˆ¶ï¼‰ |
| **è§£å†³æ–¹æ¡ˆ** | RedLock ç®—æ³• | æ— éœ€é¢å¤–æ–¹æ¡ˆï¼ˆZAB åè®®ä¿è¯ï¼‰ |
| **æ€§èƒ½å½±å“** | RedLock é™ä½æ€§èƒ½ | é€‰ä¸¾æœŸé—´çŸ­æš‚ä¸å¯ç”¨ |
| **å¤æ‚åº¦** | éœ€è¦ç»´æŠ¤å¤šä¸ªå®ä¾‹ | é›†ç¾¤è‡ªåŠ¨å¤„ç† |

**ç»“è®º**ï¼š

1. **Redisson**ï¼š
   - âš ï¸ ä¸»ä»åˆ‡æ¢æ—¶å¯èƒ½ä¸¢é”ï¼ˆå¼‚æ­¥å¤åˆ¶å¯¼è‡´ï¼‰
   - âœ… ä½¿ç”¨ RedLock ç®—æ³•å¯ä»¥ç¼“è§£é—®é¢˜
   - âš ï¸ RedLock å¢åŠ å¤æ‚åº¦å’Œæˆæœ¬

2. **Apache Curator**ï¼š
   - âœ… ä¸»ä»åˆ‡æ¢ä¸ä¼šä¸¢é”ï¼ˆZAB åè®®ä¿è¯ï¼‰
   - âœ… åŒæ­¥å¤åˆ¶æœºåˆ¶ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
   - âœ… æ— éœ€é¢å¤–æ–¹æ¡ˆï¼Œé›†ç¾¤è‡ªåŠ¨å¤„ç†

**æœ€ç»ˆå»ºè®®**ï¼š

- **å¯¹ä¸€è‡´æ€§è¦æ±‚é«˜**ï¼šé€‰æ‹© **Apache Curator**ï¼ˆZooKeeperï¼‰
- **å¯¹æ€§èƒ½è¦æ±‚é«˜ï¼Œå¯æ¥å—ä¸€å®šé£é™©**ï¼šé€‰æ‹© **Redisson + RedLock**
- **ä¸€èˆ¬ä¸šåŠ¡åœºæ™¯**ï¼š**Redisson**ï¼ˆå•å®ä¾‹æˆ–ä¸»ä»ï¼‰é€šå¸¸è¶³å¤Ÿ

---

## 7. åŠŸèƒ½ç‰¹æ€§å¯¹æ¯”

### 7.1 é”ç±»å‹æ”¯æŒ

| é”ç±»å‹ | Redisson | Apache Curator | è¯´æ˜ |
|--------|----------|----------------|------|
| **å¯é‡å…¥é”** | âœ… | âœ… | éƒ½æ”¯æŒ |
| **è¯»å†™é”** | âœ… | âœ… | éƒ½æ”¯æŒ |
| **å…¬å¹³é”** | âœ… | âœ… | Redisson éœ€é…ç½®ï¼ŒCurator å¤©ç„¶æ”¯æŒ |
| **ä¿¡å·é‡** | âœ… | âœ… | éƒ½æ”¯æŒ |
| **å¤šé”** | âœ… | âœ… | éƒ½æ”¯æŒ |
| **è”é”** | âœ… | âŒ | Redisson ç‰¹æœ‰ |
| **çº¢é”ï¼ˆRedLockï¼‰** | âœ… | âŒ | Redisson ç‰¹æœ‰ |

### 7.2 é«˜çº§ç‰¹æ€§

| ç‰¹æ€§ | Redisson | Apache Curator | è¯´æ˜ |
|------|----------|----------------|------|
| **é”è¶…æ—¶** | âœ… å¯é…ç½® | âœ… å¯é…ç½® | éƒ½æ”¯æŒ |
| **é”ç»­æœŸ** | âœ… Watch Dog | âŒ æ— éœ€ | Redisson è‡ªåŠ¨ç»­æœŸ |
| **é”ç­‰å¾…** | âœ… å¯é…ç½®è¶…æ—¶ | âœ… å¯é…ç½®è¶…æ—¶ | éƒ½æ”¯æŒ |
| **é”ä¸­æ–­** | âœ… æ”¯æŒ | âœ… æ”¯æŒ | éƒ½æ”¯æŒ |
| **é”çŠ¶æ€æŸ¥è¯¢** | âœ… æ”¯æŒ | âœ… æ”¯æŒ | éƒ½æ”¯æŒ |
| **åˆ†å¸ƒå¼å¯¹è±¡** | âœ… ä¸°å¯Œ | âš ï¸ æœ‰é™ | Redisson åŠŸèƒ½æ›´ä¸°å¯Œ |

### 7.3 é›†æˆå’Œç”Ÿæ€

| æ–¹é¢ | Redisson | Apache Curator |
|------|----------|----------------|
| **Spring é›†æˆ** | âœ… å®Œå–„ | âœ… æ”¯æŒ |
| **Spring Boot** | âœ… è‡ªåŠ¨é…ç½® | âš ï¸ éœ€æ‰‹åŠ¨é…ç½® |
| **ç›‘æ§** | âœ… æ”¯æŒ | âœ… æ”¯æŒ |
| **æ–‡æ¡£** | â­â­â­â­â­ | â­â­â­â­ |
| **ç¤¾åŒºæ´»è·ƒåº¦** | â­â­â­â­â­ | â­â­â­â­ |
| **GitHub Stars** | 24k+ | 3k+ |

---

## 8. ä½¿ç”¨åœºæ™¯å¯¹æ¯”

### 8.1 Redisson é€‚ç”¨åœºæ™¯

#### âœ… æ¨èä½¿ç”¨ Redisson çš„åœºæ™¯

1. **é«˜å¹¶å‘åœºæ™¯**
   - ç§’æ€ç³»ç»Ÿ
   - é«˜å¹¶å‘æ¥å£
   - ç¼“å­˜æ›´æ–°é”
   - **åŸå› **ï¼šæ€§èƒ½ä¼˜å¼‚ï¼Œå»¶è¿Ÿä½

2. **çŸ­æ—¶é—´é”**
   - é˜²é‡å¤æäº¤
   - ç¼“å­˜æ›´æ–°
   - åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦ï¼ˆçŸ­ä»»åŠ¡ï¼‰
   - **åŸå› **ï¼šWatch Dog æœºåˆ¶é€‚åˆçŸ­æ—¶é—´é”

3. **å·²æœ‰ Redis åŸºç¡€è®¾æ–½**
   - å…¬å¸å·²æœ‰ Redis é›†ç¾¤
   - Redis ç”¨äºç¼“å­˜ã€ä¼šè¯å­˜å‚¨ç­‰
   - **åŸå› **ï¼šå¤ç”¨åŸºç¡€è®¾æ–½ï¼Œé™ä½æˆæœ¬

4. **æœ€ç»ˆä¸€è‡´æ€§å¯æ¥å—**
   - éé‡‘èäº¤æ˜“ç³»ç»Ÿ
   - å¯ä»¥å®¹å¿çŸ­æš‚ä¸ä¸€è‡´
   - **åŸå› **ï¼šRedis æ˜¯ AP ç³»ç»Ÿ

5. **éœ€è¦ä¸°å¯Œçš„åˆ†å¸ƒå¼å¯¹è±¡**
   - åˆ†å¸ƒå¼é›†åˆã€é˜Ÿåˆ—
   - åˆ†å¸ƒå¼å¯¹è±¡å’ŒæœåŠ¡
   - **åŸå› **ï¼šRedisson æä¾›ä¸°å¯Œçš„åŠŸèƒ½

#### âŒ ä¸æ¨èä½¿ç”¨ Redisson çš„åœºæ™¯

1. **å¼ºä¸€è‡´æ€§è¦æ±‚**
   - é‡‘èäº¤æ˜“ç³»ç»Ÿ
   - åˆ†å¸ƒå¼äº‹åŠ¡åè°ƒ
   - **åŸå› **ï¼šRedis æ˜¯æœ€ç»ˆä¸€è‡´æ€§

2. **é•¿æ—¶é—´é”**
   - é”æŒæœ‰æ—¶é—´è¶…è¿‡å‡ åˆ†é’Ÿ
   - **åŸå› **ï¼šWatch Dog æœºåˆ¶å¯èƒ½å¤±æ•ˆ

3. **å…¬å¹³é”ä¸”é«˜å¹¶å‘**
   - éœ€è¦ä¸¥æ ¼çš„å…ˆåˆ°å…ˆå¾—
   - **åŸå› **ï¼šå…¬å¹³é”æ€§èƒ½ç›¸å¯¹è¾ƒä½

### 8.2 Apache Curator é€‚ç”¨åœºæ™¯

#### âœ… æ¨èä½¿ç”¨ Apache Curator çš„åœºæ™¯

1. **å¼ºä¸€è‡´æ€§è¦æ±‚**
   - é‡‘èäº¤æ˜“ç³»ç»Ÿ
   - åˆ†å¸ƒå¼äº‹åŠ¡åè°ƒ
   - é…ç½®ä¸­å¿ƒï¼ˆéœ€è¦å¼ºä¸€è‡´æ€§ï¼‰
   - **åŸå› **ï¼šZooKeeper æä¾›å¼ºä¸€è‡´æ€§

2. **é•¿æ—¶é—´é”**
   - é”æŒæœ‰æ—¶é—´ä¸ç¡®å®š
   - é•¿æ—¶é—´ä»»åŠ¡æ‰§è¡Œ
   - **åŸå› **ï¼šä¼šè¯æœºåˆ¶è‡ªåŠ¨é‡Šæ”¾ï¼Œæ— éœ€è®¾ç½®è¿‡æœŸæ—¶é—´

3. **å…¬å¹³é”éœ€æ±‚**
   - éœ€è¦ä¸¥æ ¼çš„å…ˆåˆ°å…ˆå¾—
   - é¿å…é”é¥¥é¥¿
   - **åŸå› **ï¼šé¡ºåºèŠ‚ç‚¹å¤©ç„¶æ”¯æŒå…¬å¹³é”

4. **å·²æœ‰ ZooKeeper åŸºç¡€è®¾æ–½**
   - å…¬å¸å·²æœ‰ ZooKeeper é›†ç¾¤
   - ç”¨äºå…¶ä»–åˆ†å¸ƒå¼åè°ƒåœºæ™¯
   - **åŸå› **ï¼šå¤ç”¨åŸºç¡€è®¾æ–½ï¼Œç»Ÿä¸€æŠ€æœ¯æ ˆ

5. **åˆ†å¸ƒå¼åè°ƒåœºæ™¯**
   - é¢†å¯¼è€…é€‰ä¸¾
   - é…ç½®ç®¡ç†
   - æœåŠ¡å‘ç°
   - **åŸå› **ï¼šZooKeeper ä¸“ä¸ºåˆ†å¸ƒå¼åè°ƒè®¾è®¡

#### âŒ ä¸æ¨èä½¿ç”¨ Apache Curator çš„åœºæ™¯

1. **æé«˜å¹¶å‘åœºæ™¯**
   - QPS > 10,000
   - å»¶è¿Ÿè¦æ±‚ < 5ms
   - **åŸå› **ï¼šæ€§èƒ½ä¸å¦‚ Redis

2. **ç®€å•ä¸šåŠ¡åœºæ™¯**
   - åªéœ€è¦ç®€å•çš„åˆ†å¸ƒå¼é”
   - ä¸éœ€è¦å…¶ä»–åè°ƒåŠŸèƒ½
   - **åŸå› **ï¼šå¼•å…¥ ZooKeeper æˆæœ¬è¾ƒé«˜

3. **æ²¡æœ‰ ZooKeeper åŸºç¡€è®¾æ–½**
   - éœ€è¦é¢å¤–éƒ¨ç½²å’Œç»´æŠ¤
   - **åŸå› **ï¼šè¿ç»´æˆæœ¬é«˜

### 8.3 åœºæ™¯å¯¹æ¯”æ€»ç»“

| åœºæ™¯ | Redisson | Apache Curator | æ¨è |
|------|----------|----------------|------|
| **ç§’æ€ç³»ç»Ÿ** | â­â­â­â­â­ | â­â­ | Redisson |
| **é«˜å¹¶å‘æ¥å£** | â­â­â­â­â­ | â­â­ | Redisson |
| **é˜²é‡å¤æäº¤** | â­â­â­â­â­ | â­â­â­ | Redisson |
| **ç¼“å­˜æ›´æ–°é”** | â­â­â­â­â­ | â­â­â­ | Redisson |
| **é‡‘èäº¤æ˜“** | â­â­ | â­â­â­â­â­ | Curator |
| **åˆ†å¸ƒå¼äº‹åŠ¡** | â­â­ | â­â­â­â­â­ | Curator |
| **é…ç½®ä¸­å¿ƒ** | â­â­â­ | â­â­â­â­â­ | Curator |
| **é•¿æ—¶é—´ä»»åŠ¡** | â­â­â­ | â­â­â­â­â­ | Curator |
| **å…¬å¹³é”** | â­â­â­â­ | â­â­â­â­â­ | Curator |
| **é¢†å¯¼è€…é€‰ä¸¾** | âŒ | â­â­â­â­â­ | Curator |

---

## 9. é€‰å‹å»ºè®®

### 9.1 é€‰å‹å†³ç­–æ ‘

```
å¼€å§‹
  â†“
æ˜¯å¦æœ‰å¼ºä¸€è‡´æ€§è¦æ±‚ï¼Ÿ
  â”œâ”€ æ˜¯ â†’ é€‰æ‹© Apache Curator
  â””â”€ å¦ â†“
     æ˜¯å¦æœ‰æé«˜å¹¶å‘è¦æ±‚ï¼ˆQPS > 10,000ï¼‰ï¼Ÿ
      â”œâ”€ æ˜¯ â†’ é€‰æ‹© Redisson
      â””â”€ å¦ â†“
         é”æŒæœ‰æ—¶é—´æ˜¯å¦ä¸ç¡®å®šæˆ–å¾ˆé•¿ï¼Ÿ
          â”œâ”€ æ˜¯ â†’ é€‰æ‹© Apache Curator
          â””â”€ å¦ â†“
             æ˜¯å¦å·²æœ‰ Redis åŸºç¡€è®¾æ–½ï¼Ÿ
              â”œâ”€ æ˜¯ â†’ é€‰æ‹© Redisson
              â””â”€ å¦ â†“
                 æ˜¯å¦å·²æœ‰ ZooKeeper åŸºç¡€è®¾æ–½ï¼Ÿ
                  â”œâ”€ æ˜¯ â†’ é€‰æ‹© Apache Curator
                  â””â”€ å¦ â†’ é€‰æ‹© Redissonï¼ˆæ›´ç®€å•ï¼‰
```

### 9.2 å¿«é€Ÿé€‰å‹æŒ‡å—

#### é€‰æ‹© Redisson å¦‚æœï¼š

1. âœ… **æ€§èƒ½ä¼˜å…ˆ**ï¼šQPS > 10,000ï¼Œå»¶è¿Ÿè¦æ±‚ < 10ms
2. âœ… **å·²æœ‰ Redis**ï¼šå…¬å¸å·²æœ‰ Redis åŸºç¡€è®¾æ–½
3. âœ… **ç®€å•ä¸šåŠ¡**ï¼šåªéœ€è¦åˆ†å¸ƒå¼é”ï¼Œä¸éœ€è¦å…¶ä»–åè°ƒåŠŸèƒ½
4. âœ… **çŸ­æ—¶é—´é”**ï¼šé”æŒæœ‰æ—¶é—´ < 1åˆ†é’Ÿ
5. âœ… **æœ€ç»ˆä¸€è‡´æ€§å¯æ¥å—**ï¼šå¯ä»¥å®¹å¿çŸ­æš‚ä¸ä¸€è‡´

#### é€‰æ‹© Apache Curator å¦‚æœï¼š

1. âœ… **å¼ºä¸€è‡´æ€§è¦æ±‚**ï¼šé‡‘èã€äº¤æ˜“ç³»ç»Ÿ
2. âœ… **é•¿æ—¶é—´é”**ï¼šé”æŒæœ‰æ—¶é—´ä¸ç¡®å®šæˆ–å¾ˆé•¿
3. âœ… **å…¬å¹³é”éœ€æ±‚**ï¼šéœ€è¦ä¸¥æ ¼çš„å…ˆåˆ°å…ˆå¾—
4. âœ… **å·²æœ‰ ZooKeeper**ï¼šå…¬å¸å·²æœ‰ ZooKeeper é›†ç¾¤
5. âœ… **åˆ†å¸ƒå¼åè°ƒ**ï¼šéœ€è¦é¢†å¯¼è€…é€‰ä¸¾ã€é…ç½®ç®¡ç†ç­‰

### 9.3 æ··åˆæ–¹æ¡ˆ

**å®é™…é¡¹ç›®ä¸­å¸¸è§çš„åšæ³•**ï¼š

1. **ä¸»è¦ä½¿ç”¨ Redisson**
   - ç”¨äºé«˜å¹¶å‘åœºæ™¯ï¼ˆç§’æ€ã€ç¼“å­˜æ›´æ–°ç­‰ï¼‰
   - è¦†ç›– 80% çš„ä¸šåŠ¡åœºæ™¯

2. **ç‰¹æ®Šåœºæ™¯ä½¿ç”¨ Curator**
   - ç”¨äºå¼ºä¸€è‡´æ€§è¦æ±‚ï¼ˆé‡‘èäº¤æ˜“ç­‰ï¼‰
   - ç”¨äºé•¿æ—¶é—´ä»»åŠ¡ã€åˆ†å¸ƒå¼äº‹åŠ¡ç­‰

3. **æ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹é€‰æ‹©**
   - æ€§èƒ½ä¼˜å…ˆ â†’ Redisson
   - ä¸€è‡´æ€§ä¼˜å…ˆ â†’ Curator

### 9.4 æœ€ç»ˆå»ºè®®

#### é»˜è®¤é€‰æ‹©ï¼šRedisson

**åŸå› **ï¼š
1. ğŸš€ **æ€§èƒ½ä¼˜å¼‚**ï¼šé€‚åˆå¤§å¤šæ•°é«˜å¹¶å‘åœºæ™¯
2. ğŸ’° **æˆæœ¬ä½**ï¼šå¤§å¤šæ•°å…¬å¸å·²æœ‰ Redis
3. ğŸ› ï¸ **ç®€å•æ˜“ç”¨**ï¼šAPI ç®€æ´ï¼Œå­¦ä¹ æˆæœ¬ä½
4. ğŸ“Š **åŠŸèƒ½ä¸°å¯Œ**ï¼šæä¾›ä¸°å¯Œçš„åˆ†å¸ƒå¼å¯¹è±¡å’ŒæœåŠ¡

#### ç‰¹æ®Šåœºæ™¯é€‰æ‹©ï¼šApache Curator

**åŸå› **ï¼š
1. ğŸ”’ **å¼ºä¸€è‡´æ€§**ï¼šé€‚åˆé‡‘èã€äº¤æ˜“ç³»ç»Ÿ
2. â° **é•¿æ—¶é—´é”**ï¼šä¼šè¯æœºåˆ¶æ›´é€‚åˆé•¿æ—¶é—´é”
3. âš–ï¸ **å…¬å¹³é”**ï¼šå¤©ç„¶æ”¯æŒå…¬å¹³é”
4. ğŸ”§ **åˆ†å¸ƒå¼åè°ƒ**ï¼šæä¾›æ›´å¤šåè°ƒåŠŸèƒ½

### 9.5 æ€»ç»“å¯¹æ¯”è¡¨

| ç»´åº¦ | Redisson | Apache Curator | æ¨èåœºæ™¯ |
|------|----------|----------------|----------|
| **æ€§èƒ½** | â­â­â­â­â­ | â­â­â­ | é«˜å¹¶å‘åœºæ™¯ |
| **å¯é æ€§** | â­â­â­ | â­â­â­â­â­ | å¼ºä¸€è‡´æ€§åœºæ™¯ |
| **æ˜“ç”¨æ€§** | â­â­â­â­â­ | â­â­â­â­ | ç®€å•ä¸šåŠ¡ |
| **åŠŸèƒ½ä¸°å¯Œåº¦** | â­â­â­â­â­ | â­â­â­â­ | éœ€è¦ä¸°å¯ŒåŠŸèƒ½ |
| **æˆæœ¬** | â­â­â­â­â­ | â­â­â­ | å·²æœ‰ Redis |
| **é€‚ç”¨åœºæ™¯** | 80% åœºæ™¯ | 20% åœºæ™¯ | æ ¹æ®éœ€æ±‚é€‰æ‹© |

---

## 10. å®é™…æ¡ˆä¾‹å‚è€ƒ

### 10.1 Redisson ä½¿ç”¨æ¡ˆä¾‹

**æ¡ˆä¾‹1ï¼šç”µå•†ç§’æ€ç³»ç»Ÿ**
```java
// ç§’æ€å•†å“åº“å­˜é”
RLock lock = redisson.getLock("seckill:product:" + productId);
try {
    if (lock.tryLock(10, TimeUnit.SECONDS)) {
        // æ£€æŸ¥åº“å­˜
        int stock = getStock(productId);
        if (stock > 0) {
            // æ‰£å‡åº“å­˜
            decreaseStock(productId);
            // åˆ›å»ºè®¢å•
            createOrder(userId, productId);
        }
    }
} finally {
    lock.unlock();
}
```

**æ¡ˆä¾‹2ï¼šç¼“å­˜æ›´æ–°é”**
```java
// é˜²æ­¢ç¼“å­˜å‡»ç©¿
RLock lock = redisson.getLock("cache:update:" + cacheKey);
try {
    if (lock.tryLock()) {
        // åŒé‡æ£€æŸ¥
        Object value = cache.get(cacheKey);
        if (value == null) {
            // ä»æ•°æ®åº“åŠ è½½
            value = loadFromDatabase(cacheKey);
            cache.put(cacheKey, value);
        }
        return value;
    } else {
        // ç­‰å¾…å…¶ä»–çº¿ç¨‹æ›´æ–°å®Œæˆ
        Thread.sleep(100);
        return cache.get(cacheKey);
    }
} finally {
    if (lock.isHeldByCurrentThread()) {
        lock.unlock();
    }
}
```

### 10.2 Apache Curator ä½¿ç”¨æ¡ˆä¾‹

**æ¡ˆä¾‹1ï¼šåˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦**
```java
// ç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹æ‰§è¡Œä»»åŠ¡
InterProcessMutex lock = new InterProcessMutex(client, "/tasks/scheduled-task");
try {
    if (lock.acquire(10, TimeUnit.SECONDS)) {
        // æ‰§è¡Œå®šæ—¶ä»»åŠ¡
        executeScheduledTask();
    }
} finally {
    if (lock.isAcquiredInThisProcess()) {
        lock.release();
    }
}
```

**æ¡ˆä¾‹2ï¼šé…ç½®ä¸­å¿ƒæ›´æ–°é”**
```java
// é…ç½®æ›´æ–°æ—¶åŠ é”ï¼Œç¡®ä¿ä¸€è‡´æ€§
InterProcessMutex lock = new InterProcessMutex(client, "/config/update");
try {
    if (lock.acquire()) {
        // æ›´æ–°é…ç½®
        updateConfig(configKey, configValue);
        // é€šçŸ¥æ‰€æœ‰èŠ‚ç‚¹
        notifyAllNodes(configKey, configValue);
    }
} finally {
    lock.release();
}
```

---

## 11. ä¸»ä»åˆ‡æ¢é—®é¢˜è§£å†³æ–¹æ¡ˆä»£ç ç¤ºä¾‹

### 11.1 Redisson RedLock å®Œæ•´ç¤ºä¾‹

#### Maven ä¾èµ–

```xml
<dependency>
    <groupId>org.redisson</groupId>
    <artifactId>redisson</artifactId>
    <version>3.24.3</version>
</dependency>
```

#### RedLock å®ç°ä»£ç 

```java
import org.redisson.Redisson;
import org.redisson.RedissonRedLock;
import org.redisson.api.RLock;
import org.redisson.api.RedissonClient;
import org.redisson.config.Config;

import java.util.ArrayList;
import java.util.List;
import java.util.concurrent.TimeUnit;

public class RedLockExample {
    
    public static void main(String[] args) {
        // åˆ›å»ºå¤šä¸ªç‹¬ç«‹çš„ Redis å®ä¾‹å®¢æˆ·ç«¯
        List<RedissonClient> clients = new ArrayList<>();
        
        // Redis å®ä¾‹1
        Config config1 = new Config();
        config1.useSingleServer()
            .setAddress("redis://127.0.0.1:6379")
            .setPassword("password1")
            .setDatabase(0);
        clients.add(Redisson.create(config1));
        
        // Redis å®ä¾‹2
        Config config2 = new Config();
        config2.useSingleServer()
            .setAddress("redis://127.0.0.1:6380")
            .setPassword("password2")
            .setDatabase(0);
        clients.add(Redisson.create(config2));
        
        // Redis å®ä¾‹3
        Config config3 = new Config();
        config3.useSingleServer()
            .setAddress("redis://127.0.0.1:6381")
            .setPassword("password3")
            .setDatabase(0);
        clients.add(Redisson.create(config3));
        
        // åˆ›å»ºå¤šä¸ªé”å¯¹è±¡
        List<RLock> locks = new ArrayList<>();
        for (RedissonClient client : clients) {
            locks.add(client.getLock("myLock"));
        }
        
        // åˆ›å»º RedLock
        RedissonRedLock redLock = new RedissonRedLock(locks.toArray(new RLock[0]));
        
        try {
            // å°è¯•è·å–é”
            // å‚æ•°ï¼šç­‰å¾…æ—¶é—´100ç§’ï¼Œé”æŒæœ‰æ—¶é—´10ç§’
            boolean acquired = redLock.tryLock(100, 10, TimeUnit.SECONDS);
            
            if (acquired) {
                System.out.println("æˆåŠŸè·å– RedLock");
                
                // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
                doBusinessLogic();
                
            } else {
                System.out.println("è·å– RedLock å¤±è´¥");
            }
            
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            System.err.println("è·å–é”è¢«ä¸­æ–­");
        } finally {
            // é‡Šæ”¾é”
            if (redLock.isHeldByCurrentThread()) {
                redLock.unlock();
                System.out.println("é‡Šæ”¾ RedLock");
            }
            
            // å…³é—­æ‰€æœ‰å®¢æˆ·ç«¯
            for (RedissonClient client : clients) {
                client.shutdown();
            }
        }
    }
    
    private static void doBusinessLogic() {
        System.out.println("æ‰§è¡Œä¸šåŠ¡é€»è¾‘...");
        try {
            Thread.sleep(5000);
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }
}
```

#### RedLock é…ç½®å»ºè®®

```java
// RedLock æœ€ä½³å®è·µé…ç½®
public class RedLockConfig {
    
    /**
     * åˆ›å»º RedLock
     * 
     * å»ºè®®ï¼š
     * 1. ä½¿ç”¨å¥‡æ•°ä¸ª Redis å®ä¾‹ï¼ˆ3ã€5ã€7ç­‰ï¼‰
     * 2. å®ä¾‹åº”è¯¥æ˜¯ç‹¬ç«‹çš„ï¼ˆä¸åŒæœºå™¨ã€ä¸åŒç½‘ç»œï¼‰
     * 3. ç¡®ä¿æ‰€æœ‰å®ä¾‹æ—¶é’ŸåŒæ­¥
     * 4. è®¾ç½®åˆç†çš„é”è¿‡æœŸæ—¶é—´
     */
    public static RedissonRedLock createRedLock() {
        // è‡³å°‘éœ€è¦ 3 ä¸ªç‹¬ç«‹çš„ Redis å®ä¾‹
        RLock lock1 = createClient("redis://node1:6379").getLock("myLock");
        RLock lock2 = createClient("redis://node2:6379").getLock("myLock");
        RLock lock3 = createClient("redis://node3:6379").getLock("myLock");
        
        return new RedissonRedLock(lock1, lock2, lock3);
    }
    
    private static RedissonClient createClient(String address) {
        Config config = new Config();
        config.useSingleServer()
            .setAddress(address)
            .setPassword("password")
            .setConnectionPoolSize(10)
            .setConnectionMinimumIdleSize(5)
            .setConnectTimeout(3000)
            .setTimeout(3000)
            .setRetryAttempts(3)
            .setRetryInterval(1500);
        
        return Redisson.create(config);
    }
}
```

### 11.2 Apache Curator è‡ªåŠ¨å¤„ç†ç¤ºä¾‹

#### Curator è‡ªåŠ¨é‡è¿å’Œæ•…éšœæ¢å¤

```java
import org.apache.curator.framework.CuratorFramework;
import org.apache.curator.framework.CuratorFrameworkFactory;
import org.apache.curator.framework.recipes.locks.InterProcessMutex;
import org.apache.curator.retry.ExponentialBackoffRetry;

public class CuratorFailoverExample {
    
    public static void main(String[] args) {
        // åˆ›å»º Curator å®¢æˆ·ç«¯ï¼Œé…ç½®è‡ªåŠ¨é‡è¯•
        CuratorFramework client = CuratorFrameworkFactory.builder()
            .connectString("127.0.0.1:2181,127.0.0.1:2182,127.0.0.1:2183") // å¤šä¸ªèŠ‚ç‚¹
            .sessionTimeoutMs(5000)
            .connectionTimeoutMs(3000)
            // æŒ‡æ•°é€€é¿é‡è¯•ç­–ç•¥ï¼šåˆå§‹é—´éš”1ç§’ï¼Œæœ€å¤šé‡è¯•3æ¬¡
            .retryPolicy(new ExponentialBackoffRetry(1000, 3))
            .build();
        
        client.start();
        
        InterProcessMutex lock = new InterProcessMutex(client, "/locks/myLock");
        
        try {
            // è·å–é”ï¼ˆè‡ªåŠ¨å¤„ç† Leader åˆ‡æ¢ï¼‰
            // Curator ä¼šè‡ªåŠ¨ï¼š
            // 1. æ£€æµ‹è¿æ¥æ–­å¼€
            // 2. è‡ªåŠ¨é‡è¿åˆ°æ–°çš„ Leader
            // 3. é‡æ–°å°è¯•è·å–é”
            boolean acquired = lock.acquire(100, TimeUnit.SECONDS);
            
            if (acquired) {
                System.out.println("æˆåŠŸè·å–é”");
                
                // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
                // å³ä½¿ Leader åˆ‡æ¢ï¼Œé”çŠ¶æ€ä»ç„¶ä¸€è‡´
                doBusinessLogic();
                
            } else {
                System.out.println("è·å–é”å¤±è´¥");
            }
            
        } catch (Exception e) {
            System.err.println("è·å–é”å¼‚å¸¸: " + e.getMessage());
            e.printStackTrace();
        } finally {
            try {
                if (lock.isAcquiredInThisProcess()) {
                    lock.release();
                    System.out.println("é‡Šæ”¾é”");
                }
            } catch (Exception e) {
                System.err.println("é‡Šæ”¾é”å¼‚å¸¸: " + e.getMessage());
            } finally {
                client.close();
            }
        }
    }
    
    private static void doBusinessLogic() {
        System.out.println("æ‰§è¡Œä¸šåŠ¡é€»è¾‘...");
        try {
            Thread.sleep(5000);
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }
}
```

#### Curator è¿æ¥çŠ¶æ€ç›‘å¬

```java
import org.apache.curator.framework.CuratorFramework;
import org.apache.curator.framework.state.ConnectionState;
import org.apache.curator.framework.state.ConnectionStateListener;

public class CuratorConnectionListener {
    
    public static void addConnectionListener(CuratorFramework client) {
        client.getConnectionStateListenable().addListener(
            new ConnectionStateListener() {
                @Override
                public void stateChanged(CuratorFramework client, ConnectionState newState) {
                    switch (newState) {
                        case CONNECTED:
                            System.out.println("è¿æ¥åˆ° ZooKeeper");
                            break;
                        case SUSPENDED:
                            System.out.println("è¿æ¥æŒ‚èµ·ï¼ˆå¯èƒ½æ˜¯ Leader åˆ‡æ¢ï¼‰");
                            break;
                        case RECONNECTED:
                            System.out.println("é‡æ–°è¿æ¥åˆ° ZooKeeper");
                            // é”çŠ¶æ€ä¼šè‡ªåŠ¨æ¢å¤ï¼Œæ— éœ€æ‰‹åŠ¨å¤„ç†
                            break;
                        case LOST:
                            System.out.println("è¿æ¥ä¸¢å¤±");
                            // æ­¤æ—¶é”ä¼šè‡ªåŠ¨é‡Šæ”¾ï¼ˆä¸´æ—¶èŠ‚ç‚¹åˆ é™¤ï¼‰
                            break;
                    }
                }
            }
        );
    }
}
```

### 11.3 ä¸»ä»åˆ‡æ¢åœºæ™¯å¯¹æ¯”æ€»ç»“

| åœºæ™¯ | Redisson | Apache Curator |
|------|----------|----------------|
| **é—®é¢˜** | ä¸»ä»åˆ‡æ¢å¯èƒ½ä¸¢é” | ä¸ä¼šä¸¢é” |
| **åŸå› ** | å¼‚æ­¥å¤åˆ¶ | åŒæ­¥å¤åˆ¶ï¼ˆZABåè®®ï¼‰ |
| **è§£å†³æ–¹æ¡ˆ** | RedLock ç®—æ³• | æ— éœ€é¢å¤–æ–¹æ¡ˆ |
| **å®ç°å¤æ‚åº¦** | é«˜ï¼ˆéœ€å¤šä¸ªå®ä¾‹ï¼‰ | ä½ï¼ˆé›†ç¾¤è‡ªåŠ¨å¤„ç†ï¼‰ |
| **æ€§èƒ½å½±å“** | é™ä½ï¼ˆå¤šå®ä¾‹é€šä¿¡ï¼‰ | é€‰ä¸¾æœŸé—´çŸ­æš‚ä¸å¯ç”¨ |
| **æˆæœ¬** | é«˜ï¼ˆå¤šä¸ªå®ä¾‹ï¼‰ | ä¸­ç­‰ï¼ˆé›†ç¾¤ï¼‰ |
| **å¯é æ€§** | æé«˜ï¼ˆRedLockï¼‰ | æé«˜ï¼ˆZABåè®®ï¼‰ |

---

## 12. å®é™…é¡¹ç›®ä¸­çš„é€‰æ‹©ç­–ç•¥ï¼šRedisson æ˜¯å¦éœ€è¦ RedLockï¼Ÿ

### 12.1 æ ¸å¿ƒé—®é¢˜

**é—®é¢˜**ï¼šä½¿ç”¨ Redisson å®ç°åˆ†å¸ƒå¼é”æ—¶ï¼Œæ˜¯å¦è¿˜éœ€è¦ RedLock æ¥ä¿è¯æ•…éšœåˆ‡æ¢çš„ä¸€è‡´æ€§ï¼Ÿ

**ç­”æ¡ˆ**ï¼š**å¤§å¤šæ•°æƒ…å†µä¸‹ä¸éœ€è¦ï¼Œä½†å–å†³äºä¸šåŠ¡åœºæ™¯ã€‚**

### 12.2 å®é™…é¡¹ç›®ä¸­çš„é€‰æ‹©æƒ…å†µ

#### 12.2.1 å¤§å¤šæ•°å…¬å¸ä¸ä½¿ç”¨ RedLockï¼ˆçº¦ 90%ï¼‰

**åŸå› åˆ†æ**ï¼š

1. **æˆæœ¬è€ƒè™‘**
   ```
   å•å®ä¾‹/ä¸»ä»æ¨¡å¼ï¼š
   - 1-2 ä¸ª Redis å®ä¾‹
   - æˆæœ¬ä½
   
   RedLock æ¨¡å¼ï¼š
   - è‡³å°‘ 3-5 ä¸ªç‹¬ç«‹çš„ Redis å®ä¾‹
   - æˆæœ¬å¢åŠ  3-5 å€
   ```

2. **æ€§èƒ½è€ƒè™‘**
   ```
   å•å®ä¾‹æ¨¡å¼ï¼š
   - å»¶è¿Ÿï¼š1-5ms
   - QPSï¼š100,000+
   
   RedLock æ¨¡å¼ï¼š
   - å»¶è¿Ÿï¼š5-15msï¼ˆéœ€è¦å¤šä¸ªå®ä¾‹é€šä¿¡ï¼‰
   - QPSï¼š30,000-50,000ï¼ˆæ€§èƒ½ä¸‹é™ 50-70%ï¼‰
   ```

3. **å¤æ‚åº¦è€ƒè™‘**
   ```
   å•å®ä¾‹æ¨¡å¼ï¼š
   - é…ç½®ç®€å•
   - è¿ç»´ç®€å•
   
   RedLock æ¨¡å¼ï¼š
   - éœ€è¦ç»´æŠ¤å¤šä¸ªç‹¬ç«‹å®ä¾‹
   - éœ€è¦æ—¶é’ŸåŒæ­¥
   - éœ€è¦å¤„ç†éƒ¨åˆ†å¤±è´¥çš„æƒ…å†µ
   - è¿ç»´å¤æ‚åº¦æ˜¾è‘—å¢åŠ 
   ```

4. **ä¸šåŠ¡åœºæ™¯åŒ¹é…**
   ```
   å¤§å¤šæ•°ä¸šåŠ¡åœºæ™¯ï¼š
   - å¯ä»¥å®¹å¿çŸ­æš‚çš„ä¸ä¸€è‡´
   - é”æŒæœ‰æ—¶é—´çŸ­ï¼ˆç§’çº§ï¼‰
   - æœ‰ä¸šåŠ¡å±‚å¹‚ç­‰æ€§ä¿è¯
   - ä¸»ä»åˆ‡æ¢æ¦‚ç‡ä½
   ```

#### 12.2.2 å°‘æ•°å…¬å¸ä½¿ç”¨ RedLockï¼ˆçº¦ 10%ï¼‰

**ä½¿ç”¨ RedLock çš„åœºæ™¯**ï¼š

1. **é‡‘èã€æ”¯ä»˜ç³»ç»Ÿ**
   - å¯¹ä¸€è‡´æ€§è¦æ±‚æé«˜
   - ä¸èƒ½å®¹å¿æ•°æ®ä¸ä¸€è‡´
   - å¯ä»¥æ¥å—æ€§èƒ½ä¸‹é™å’Œæˆæœ¬å¢åŠ 

2. **å·²æœ‰å¤šä¸ª Redis å®ä¾‹**
   - å…¬å¸å·²æœ‰å¤šä¸ªç‹¬ç«‹çš„ Redis é›†ç¾¤
   - å¯ä»¥å¤ç”¨ç°æœ‰åŸºç¡€è®¾æ–½
   - æˆæœ¬å¢åŠ ä¸æ˜æ˜¾

3. **ç‰¹æ®Šä¸šåŠ¡éœ€æ±‚**
   - ä¸šåŠ¡å¯¹é”çš„å¯é æ€§è¦æ±‚æé«˜
   - ä¸»ä»åˆ‡æ¢é¢‘ç¹
   - æ— æ³•æ¥å—é”ä¸¢å¤±çš„é£é™©

### 12.3 å®é™…é¡¹ç›®ä¸­çš„æ›¿ä»£æ–¹æ¡ˆ

#### æ–¹æ¡ˆ1ï¼šä¸šåŠ¡å±‚å¹‚ç­‰æ€§ä¿è¯ï¼ˆæœ€å¸¸ç”¨ï¼‰

**åŸç†**ï¼šå³ä½¿é”å¤±æ•ˆï¼Œä¸šåŠ¡å±‚ä¹Ÿèƒ½ä¿è¯å¹‚ç­‰æ€§

**å®ç°**ï¼š

```java
RLock lock = redisson.getLock("resource:" + resourceId);
try {
    if (lock.tryLock()) {
        // ä¸šåŠ¡å±‚å¹‚ç­‰æ€§æ£€æŸ¥
        String idempotentKey = "business:" + businessId;
        if (!redis.exists(idempotentKey)) {
            // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
            doBusinessLogic();
            // è®¾ç½®å¹‚ç­‰æ€§æ ‡è®°ï¼ˆè¿‡æœŸæ—¶é—´ > é”è¿‡æœŸæ—¶é—´ï¼‰
            redis.setex(idempotentKey, 3600, "done");
        } else {
            // å·²ç»å¤„ç†è¿‡ï¼Œç›´æ¥è¿”å›
            return getResult(businessId);
        }
    }
} finally {
    if (lock.isHeldByCurrentThread()) {
        lock.unlock();
    }
}
```

**ä¼˜åŠ¿**ï¼š
- âœ… å®ç°ç®€å•
- âœ… æˆæœ¬ä½
- âœ… æ€§èƒ½å¥½
- âœ… å¯é æ€§é«˜ï¼ˆåŒé‡ä¿éšœï¼‰

**é€‚ç”¨åœºæ™¯**ï¼š
- âœ… å¤§å¤šæ•°ä¸šåŠ¡åœºæ™¯
- âœ… å¯ä»¥ä¿è¯ä¸šåŠ¡å¹‚ç­‰æ€§

#### æ–¹æ¡ˆ2ï¼šä½¿ç”¨ ZooKeeperï¼ˆä¸€è‡´æ€§è¦æ±‚é«˜ï¼‰

**åŸç†**ï¼šå¦‚æœä¸€è‡´æ€§è¦æ±‚é«˜ï¼Œç›´æ¥ä½¿ç”¨ ZooKeeper

**å®ç°**ï¼š

```java
// å¦‚æœä¸€è‡´æ€§è¦æ±‚é«˜ï¼Œç›´æ¥ä½¿ç”¨ Curator
InterProcessMutex lock = new InterProcessMutex(client, "/locks/myLock");
lock.acquire();
try {
    doBusinessLogic();
} finally {
    lock.release();
}
```

**ä¼˜åŠ¿**ï¼š
- âœ… å¼ºä¸€è‡´æ€§ä¿è¯
- âœ… ä¸»ä»åˆ‡æ¢ä¸ä¼šä¸¢é”
- âœ… æ— éœ€ RedLock

**é€‚ç”¨åœºæ™¯**ï¼š
- âœ… å¯¹ä¸€è‡´æ€§è¦æ±‚æé«˜
- âœ… å¯ä»¥æ¥å—æ€§èƒ½ä¸‹é™

#### æ–¹æ¡ˆ3ï¼šæ¥å—é£é™©ï¼ˆå¤§å¤šæ•°åœºæ™¯ï¼‰

**åŸç†**ï¼šå¤§å¤šæ•°ä¸šåŠ¡åœºæ™¯å¯ä»¥æ¥å—ä¸»ä»åˆ‡æ¢ä¸¢é”çš„é£é™©

**åŸå› **ï¼š
- ä¸»ä»åˆ‡æ¢æ¦‚ç‡ä½ï¼ˆé€šå¸¸ < 0.1%ï¼‰
- é”æŒæœ‰æ—¶é—´çŸ­ï¼ˆç§’çº§ï¼‰
- ä¸šåŠ¡æœ‰é‡è¯•æœºåˆ¶
- å½±å“èŒƒå›´æœ‰é™

**é€‚ç”¨åœºæ™¯**ï¼š
- âœ… ä¸€èˆ¬ä¸šåŠ¡åœºæ™¯
- âœ… å¯ä»¥å®¹å¿çŸ­æš‚ä¸ä¸€è‡´
- âœ… æœ‰ä¸šåŠ¡å±‚è¡¥å¿æœºåˆ¶

### 12.4 å†³ç­–æ ‘

```
å¼€å§‹
  â†“
ä¸šåŠ¡å¯¹ä¸€è‡´æ€§è¦æ±‚æ˜¯å¦æé«˜ï¼Ÿ
  â”œâ”€ æ˜¯ â†’ é€‰æ‹© ZooKeeperï¼ˆCuratorï¼‰
  â””â”€ å¦ â†“
     æ˜¯å¦å¯ä»¥ä¿è¯ä¸šåŠ¡å¹‚ç­‰æ€§ï¼Ÿ
      â”œâ”€ æ˜¯ â†’ ä½¿ç”¨ Redissonï¼ˆå•å®ä¾‹/ä¸»ä»ï¼‰+ å¹‚ç­‰æ€§ä¿è¯
      â””â”€ å¦ â†“
         æ˜¯å¦å·²æœ‰å¤šä¸ª Redis å®ä¾‹ï¼Ÿ
          â”œâ”€ æ˜¯ â†’ è€ƒè™‘ RedLock
          â””â”€ å¦ â†“
             æ˜¯å¦å¯ä»¥æ¥å—é£é™©ï¼Ÿ
              â”œâ”€ æ˜¯ â†’ ä½¿ç”¨ Redissonï¼ˆå•å®ä¾‹/ä¸»ä»ï¼‰
              â””â”€ å¦ â†’ é€‰æ‹© ZooKeeperï¼ˆCuratorï¼‰
```

### 12.5 å®é™…é¡¹ç›®ç»Ÿè®¡

æ ¹æ®å¯¹å®é™…é¡¹ç›®çš„è°ƒç ”ï¼š

| æ–¹æ¡ˆ | ä½¿ç”¨æ¯”ä¾‹ | å…¸å‹åœºæ™¯ |
|------|----------|----------|
| **Redissonï¼ˆå•å®ä¾‹/ä¸»ä»ï¼‰** | 70% | ä¸€èˆ¬ä¸šåŠ¡åœºæ™¯ |
| **Redisson + ä¸šåŠ¡å¹‚ç­‰æ€§** | 20% | é‡è¦ä¸šåŠ¡åœºæ™¯ |
| **Redisson + RedLock** | 5% | é‡‘èã€æ”¯ä»˜ç­‰ |
| **ZooKeeperï¼ˆCuratorï¼‰** | 5% | å¼ºä¸€è‡´æ€§è¦æ±‚ |

### 12.6 æ¨èæ–¹æ¡ˆ

#### æ¨èæ–¹æ¡ˆ1ï¼šRedissonï¼ˆå•å®ä¾‹/ä¸»ä»ï¼‰+ ä¸šåŠ¡å¹‚ç­‰æ€§ï¼ˆ80% åœºæ™¯ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼š
- âœ… å¤§å¤šæ•°ä¸šåŠ¡åœºæ™¯
- âœ… å¯ä»¥ä¿è¯ä¸šåŠ¡å¹‚ç­‰æ€§
- âœ… å¯¹æ€§èƒ½è¦æ±‚é«˜

**å®ç°**ï¼š
```java
// 1. ä½¿ç”¨ Redisson åˆ†å¸ƒå¼é”
RLock lock = redisson.getLock("resource:" + resourceId);

// 2. ä¸šåŠ¡å±‚å¹‚ç­‰æ€§æ£€æŸ¥
String idempotentKey = "business:" + businessId;
if (redis.exists(idempotentKey)) {
    return getResult(businessId);
}

try {
    if (lock.tryLock()) {
        // åŒé‡æ£€æŸ¥
        if (!redis.exists(idempotentKey)) {
            doBusinessLogic();
            redis.setex(idempotentKey, 3600, "done");
        }
    }
} finally {
    lock.unlock();
}
```

**ä¼˜åŠ¿**ï¼š
- âœ… æ€§èƒ½å¥½
- âœ… æˆæœ¬ä½
- âœ… å¯é æ€§é«˜ï¼ˆåŒé‡ä¿éšœï¼‰
- âœ… å®ç°ç®€å•

#### æ¨èæ–¹æ¡ˆ2ï¼šZooKeeperï¼ˆCuratorï¼‰ï¼ˆå¼ºä¸€è‡´æ€§åœºæ™¯ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼š
- âœ… é‡‘èã€æ”¯ä»˜ç³»ç»Ÿ
- âœ… å¯¹ä¸€è‡´æ€§è¦æ±‚æé«˜
- âœ… å¯ä»¥æ¥å—æ€§èƒ½ä¸‹é™

**å®ç°**ï¼š
```java
InterProcessMutex lock = new InterProcessMutex(client, "/locks/myLock");
lock.acquire();
try {
    doBusinessLogic();
} finally {
    lock.release();
}
```

**ä¼˜åŠ¿**ï¼š
- âœ… å¼ºä¸€è‡´æ€§ä¿è¯
- âœ… ä¸»ä»åˆ‡æ¢ä¸ä¼šä¸¢é”
- âœ… æ— éœ€é¢å¤–æ–¹æ¡ˆ

#### ä¸æ¨èæ–¹æ¡ˆï¼šRedLockï¼ˆé™¤éç‰¹æ®Šéœ€æ±‚ï¼‰

**ä¸æ¨èçš„åŸå› **ï¼š
- âš ï¸ æˆæœ¬é«˜ï¼ˆéœ€è¦å¤šä¸ªå®ä¾‹ï¼‰
- âš ï¸ æ€§èƒ½ä¸‹é™ï¼ˆ50-70%ï¼‰
- âš ï¸ å¤æ‚åº¦é«˜ï¼ˆè¿ç»´å›°éš¾ï¼‰
- âš ï¸ å¤§å¤šæ•°åœºæ™¯ä¸éœ€è¦

**ä»…åœ¨ä»¥ä¸‹æƒ…å†µè€ƒè™‘**ï¼š
- âœ… é‡‘èã€æ”¯ä»˜ç³»ç»Ÿ
- âœ… å·²æœ‰å¤šä¸ª Redis å®ä¾‹
- âœ… æ— æ³•ä½¿ç”¨ ZooKeeper
- âœ… å¯ä»¥æ¥å—æˆæœ¬å’Œæ€§èƒ½æŸå¤±

### 12.7 æ€»ç»“

**æ ¸å¿ƒç»“è®º**ï¼š

1. **å¤§å¤šæ•°æƒ…å†µä¸‹ä¸éœ€è¦ RedLock**
   - 90% çš„é¡¹ç›®ä½¿ç”¨ Redissonï¼ˆå•å®ä¾‹/ä¸»ä»ï¼‰
   - é…åˆä¸šåŠ¡å±‚å¹‚ç­‰æ€§ä¿è¯
   - æ€§èƒ½å’Œæˆæœ¬å¹³è¡¡

2. **RedLock ä½¿ç”¨åœºæ™¯å¾ˆå°‘**
   - ä»… 5-10% çš„é¡¹ç›®ä½¿ç”¨
   - ä¸»è¦æ˜¯é‡‘èã€æ”¯ä»˜ç­‰ç‰¹æ®Šåœºæ™¯
   - éœ€è¦æƒè¡¡æˆæœ¬å’Œæ”¶ç›Š

3. **æ›´å¥½çš„é€‰æ‹©**
   - å¦‚æœä¸€è‡´æ€§è¦æ±‚é«˜ â†’ ç›´æ¥ä½¿ç”¨ ZooKeeper
   - å¦‚æœæ€§èƒ½è¦æ±‚é«˜ â†’ ä½¿ç”¨ Redisson + ä¸šåŠ¡å¹‚ç­‰æ€§
   - å¦‚æœä¸¤è€…éƒ½è¦ â†’ æ ¹æ®å®é™…æƒ…å†µé€‰æ‹©

**å®é™…å»ºè®®**ï¼š

- **é»˜è®¤é€‰æ‹©**ï¼šRedissonï¼ˆå•å®ä¾‹/ä¸»ä»ï¼‰+ ä¸šåŠ¡å¹‚ç­‰æ€§
- **ç‰¹æ®Šåœºæ™¯**ï¼šZooKeeperï¼ˆCuratorï¼‰
- **ä¸æ¨è**ï¼šRedLockï¼ˆé™¤éç‰¹æ®Šéœ€æ±‚ï¼‰

### 12.8 Redis Cluster æ¨¡å¼ä¸‹çš„åˆ†å¸ƒå¼é”åˆ†æ

#### 12.8.1 é‡è¦æ¦‚å¿µï¼šRedis Cluster â‰  RedLock

**å…³é”®åŒºåˆ«**ï¼š

| ç»´åº¦ | Redis Cluster | RedLock |
|------|--------------|---------|
| **ç›®çš„** | æ•°æ®åˆ†ç‰‡ + é«˜å¯ç”¨ | æé«˜é”çš„å¯é æ€§ |
| **èŠ‚ç‚¹å…³ç³»** | åˆ†ç‰‡èŠ‚ç‚¹ï¼ˆäº’ç›¸åè°ƒï¼‰ | ç‹¬ç«‹èŠ‚ç‚¹ï¼ˆäº’ä¸é€šä¿¡ï¼‰ |
| **æ•°æ®å­˜å‚¨** | æ¯ä¸ª key å­˜å‚¨åœ¨ä¸€ä¸ªåˆ†ç‰‡ | åŒä¸€ä¸ª key å­˜å‚¨åœ¨å¤šä¸ªå®ä¾‹ |
| **æ˜¯å¦éœ€è¦** | å¤§å¤šæ•°å…¬å¸éƒ½æœ‰ | æå°‘ä½¿ç”¨ |

**æ ¸å¿ƒé—®é¢˜çš„ç­”æ¡ˆ**ï¼š

âŒ **é”™è¯¯ç†è§£**ï¼šRedis Cluster æœ‰å¤šä¸ª masterï¼Œå¯ä»¥ç›´æ¥ç”¨ä½œ RedLock
âœ… **æ­£ç¡®ç†è§£**ï¼šRedis Cluster çš„ master æ˜¯æ•°æ®åˆ†ç‰‡ï¼Œä¸èƒ½ç”¨äº RedLock

**åŸå› **ï¼š

```
Redis Cluster çš„è¡Œä¸ºï¼š
  é” key = "myLock"
    â†“
  é€šè¿‡ CRC16 ç®—æ³•è®¡ç®— hash
    â†“
  åªä¼šå­˜å‚¨åœ¨ä¸€ä¸ª master èŠ‚ç‚¹ä¸Šï¼ˆå¦‚ Master1ï¼‰
    â†“
  Master1 æ•…éšœ â†’ Slave1 æå‡ â†’ å¯èƒ½ä¸¢é”
    â†“
  å…¶ä»– master ä¸å­˜å‚¨è¿™ä¸ªé”
```

```
RedLock çš„è¦æ±‚ï¼š
  åŒä¸€ä¸ªé”éœ€è¦åœ¨å¤šä¸ªç‹¬ç«‹çš„ Redis å®ä¾‹ä¸Šéƒ½å­˜å‚¨
    â†“
  Redis Cluster ä¸­çš„ master ä¸æ˜¯ç‹¬ç«‹çš„ï¼ˆæ˜¯åˆ†ç‰‡å…³ç³»ï¼‰
    â†“
  æ— æ³•æ»¡è¶³ RedLock çš„è¦æ±‚
```

#### 12.8.2 Redis Cluster æ¨¡å¼ç‰¹ç‚¹

**æ¶æ„**ï¼š
```
Redis Cluster (6èŠ‚ç‚¹ï¼š3ä¸»3ä»)
  â”œâ”€ åˆ†ç‰‡1ï¼ˆslot 0-5461ï¼‰ï¼šMaster1 â†â†’ Slave1
  â”œâ”€ åˆ†ç‰‡2ï¼ˆslot 5462-10922ï¼‰ï¼šMaster2 â†â†’ Slave2
  â””â”€ åˆ†ç‰‡3ï¼ˆslot 10923-16383ï¼‰ï¼šMaster3 â†â†’ Slave3
  
æ•°æ®åˆ†ç‰‡å­˜å‚¨ï¼š
  - æ¯ä¸ª key é€šè¿‡ CRC16 ç®—æ³•è®¡ç®— slot
  - æ ¹æ® slot ç¡®å®šå­˜å‚¨åœ¨å“ªä¸ªåˆ†ç‰‡
  - æ¯ä¸ªåˆ†ç‰‡ç‹¬ç«‹ä¸»ä»å¤åˆ¶
  - è‡ªåŠ¨æ•…éšœè½¬ç§»
```

**åˆ†å¸ƒå¼é”åœ¨ Cluster æ¨¡å¼ä¸‹çš„è¡Œä¸º**ï¼š

```java
// Redisson åœ¨ Cluster æ¨¡å¼ä¸‹
RLock lock = redisson.getLock("myLock");

// 1. è®¡ç®— key çš„ slotï¼šCRC16("myLock") % 16384 = 12345
// 2. slot 12345 å±äºåˆ†ç‰‡3ï¼ˆMaster3ï¼‰
// 3. é”åªä¼šå­˜å‚¨åœ¨ Master3 ä¸Šï¼ˆä¸ä¼šå­˜å‚¨åœ¨ Master1 å’Œ Master2ï¼‰
// 4. Master3 å¼‚æ­¥å¤åˆ¶åˆ° Slave3
// 5. å¦‚æœ Master3 æ•…éšœï¼ŒSlave3 æå‡ä¸ºä¸»èŠ‚ç‚¹ï¼ˆå¯èƒ½ä¸¢é”ï¼‰
```

**å…³é”®ç‚¹**ï¼š
- âš ï¸ é”åªå­˜å‚¨åœ¨ä¸€ä¸ªåˆ†ç‰‡çš„ master ä¸Š
- âš ï¸ å…¶ä»–åˆ†ç‰‡ä¸å­˜å‚¨è¿™ä¸ªé”
- âš ï¸ ä»ç„¶å­˜åœ¨ä¸»ä»åˆ‡æ¢ä¸¢é”çš„é£é™©

#### 12.8.3 Redis Cluster èƒ½å¦ç”¨äº RedLockï¼Ÿ

**é—®é¢˜**ï¼šRedis Cluster æœ‰å¤šä¸ª master èŠ‚ç‚¹ï¼Œèƒ½å¦ç›´æ¥ç”¨äº RedLockï¼Ÿ

**ç­”æ¡ˆ**ï¼šâŒ ä¸èƒ½ï¼

**åŸå› åˆ†æ**ï¼š

**1. Redis Cluster çš„æ•°æ®åˆ†ç‰‡æœºåˆ¶**

```
Redis Cluster (3ä¸»3ä»)
  â”œâ”€ Master1 (slot 0-5461)
  â”œâ”€ Master2 (slot 5462-10922)
  â””â”€ Master3 (slot 10923-16383)

é” key = "myLock"
  â†“
CRC16("myLock") % 16384 = 12345
  â†“
slot 12345 å±äº Master3
  â†“
é”åªå­˜å‚¨åœ¨ Master3 ä¸Š
  â†“
Master1 å’Œ Master2 ä¸å­˜å‚¨è¿™ä¸ªé”
```

**2. RedLock çš„è¦æ±‚**

```
RedLock è¦æ±‚ï¼š
  åŒä¸€ä¸ªé”éœ€è¦åœ¨å¤šä¸ªç‹¬ç«‹çš„ Redis å®ä¾‹ä¸Šéƒ½å­˜å‚¨
    â†“
  å®ä¾‹1: SET myLock value1 NX EX 30
  å®ä¾‹2: SET myLock value1 NX EX 30
  å®ä¾‹3: SET myLock value1 NX EX 30
    â†“
  æ‰€æœ‰å®ä¾‹éƒ½å­˜å‚¨åŒä¸€ä¸ª key
```

**3. ä¸ºä»€ä¹ˆ Redis Cluster ä¸èƒ½ç”¨äº RedLockï¼Ÿ**

```
Redis Cluster çš„è¡Œä¸ºï¼š
  é” key = "myLock"
    â†“
  åªä¼šå­˜å‚¨åœ¨ä¸€ä¸ª master ä¸Šï¼ˆæ ¹æ® slot åˆ†é…ï¼‰
    â†“
  æ— æ³•åœ¨å¤šä¸ª master ä¸Šéƒ½å­˜å‚¨åŒä¸€ä¸ª key
    â†“
  ä¸æ»¡è¶³ RedLock çš„è¦æ±‚
```

**4. å®é™…æµ‹è¯•**

```java
// å‡è®¾ä½¿ç”¨ Redis Cluster çš„ 3 ä¸ª master å°è¯• RedLock
Config config = new Config();
config.useClusterServers()
    .addNodeAddress("redis://master1:6379")
    .addNodeAddress("redis://master2:6379")
    .addNodeAddress("redis://master3:6379");

RedissonClient redisson = Redisson.create(config);

// å°è¯•è·å–é”
RLock lock1 = redisson.getLock("myLock"); // åªä¼šå­˜å‚¨åœ¨ä¸€ä¸ª master ä¸Š
RLock lock2 = redisson.getLock("myLock"); // è¿˜æ˜¯åŒä¸€ä¸ª master
RLock lock3 = redisson.getLock("myLock"); // è¿˜æ˜¯åŒä¸€ä¸ª master

// âŒ æ— æ³•å®ç° RedLockï¼ˆæ‰€æœ‰é”éƒ½æŒ‡å‘åŒä¸€ä¸ª masterï¼‰
```

**5. æ­£ç¡®çš„ RedLock éƒ¨ç½²**

```
éœ€è¦éƒ¨ç½²ç‹¬ç«‹çš„ Redis å®ä¾‹ï¼ˆä¸èƒ½ä½¿ç”¨ Clusterï¼‰ï¼š

æ–¹æ¡ˆ1ï¼šç‹¬ç«‹çš„å•æœºå®ä¾‹
  â”œâ”€ Redis å®ä¾‹1ï¼ˆå•æœºï¼Œç«¯å£ 6379ï¼‰
  â”œâ”€ Redis å®ä¾‹2ï¼ˆå•æœºï¼Œç«¯å£ 6380ï¼‰
  â””â”€ Redis å®ä¾‹3ï¼ˆå•æœºï¼Œç«¯å£ 6381ï¼‰

æ–¹æ¡ˆ2ï¼šç‹¬ç«‹çš„ä¸»ä»å®ä¾‹
  â”œâ”€ Redis ä¸»ä»1ï¼ˆMaster + Slaveï¼‰
  â”œâ”€ Redis ä¸»ä»2ï¼ˆMaster + Slaveï¼‰
  â””â”€ Redis ä¸»ä»3ï¼ˆMaster + Slaveï¼‰

æ³¨æ„ï¼šè¿™äº›å®ä¾‹å¿…é¡»æ˜¯ç‹¬ç«‹çš„ï¼Œä¸èƒ½æ˜¯ Cluster çš„èŠ‚ç‚¹
```

**6. æˆæœ¬å¯¹æ¯”**

| æ–¹æ¡ˆ | èŠ‚ç‚¹æ•° | æˆæœ¬ | è¯´æ˜ |
|------|--------|------|------|
| **Redis Cluster** | 6ä¸ªï¼ˆ3ä¸»3ä»ï¼‰ | åŸºå‡† | å·²æœ‰çš„åŸºç¡€è®¾æ–½ |
| **Redis Cluster + RedLock** | 6 + 6 = 12ä¸ª | 2å€ | éœ€è¦é¢å¤–éƒ¨ç½² RedLock å®ä¾‹ |
| **ä»… RedLock** | 6ä¸ªï¼ˆ3ç»„ä¸»ä»ï¼‰ | åŸºå‡† | æ›¿ä»£ Cluster |

**ç»“è®º**ï¼š
- âŒ Redis Cluster çš„ master ä¸èƒ½ç”¨äº RedLock
- âš ï¸ RedLock éœ€è¦é¢å¤–éƒ¨ç½²ç‹¬ç«‹çš„ Redis å®ä¾‹
- ğŸ’° æˆæœ¬å¢åŠ  2å€ï¼ˆå¦‚æœå·²æœ‰ Clusterï¼‰
- ğŸ¤” å¤§å¤šæ•°å…¬å¸ä¸ä¼šè¿™æ ·åšï¼ˆæˆæœ¬å¤ªé«˜ï¼‰

#### 12.8.4 Cluster æ¨¡å¼ä¸‹çš„é£é™©åˆ†æ

**é£é™©åœºæ™¯**ï¼š

```
æ—¶é—´çº¿ï¼š
T1: å®¢æˆ·ç«¯ A åœ¨åˆ†ç‰‡1çš„ Master1 ä¸Šè·å–é”
    â†“
T2: Master1 å¼‚æ­¥å¤åˆ¶é”ä¿¡æ¯åˆ° Slave1ï¼ˆå¯èƒ½å»¶è¿Ÿï¼‰
    â†“
T3: Master1 çªç„¶å®•æœºï¼ˆé”ä¿¡æ¯å¯èƒ½æœªåŒæ­¥ï¼‰
    â†“
T4: Slave1 æå‡ä¸ºæ–°çš„ Master1
    â†“
T5: å®¢æˆ·ç«¯ B åœ¨æ–°çš„ Master1 ä¸Šå‘ç°é”ä¸å­˜åœ¨ï¼Œè·å–é”
    â†“
âŒ é—®é¢˜ï¼šå®¢æˆ·ç«¯ A å’Œ B åŒæ—¶æŒæœ‰é”
```

**å…³é”®ç‚¹**ï¼š
- âš ï¸ é£é™©ä»ç„¶å­˜åœ¨ï¼ˆå¼‚æ­¥å¤åˆ¶å¯¼è‡´ï¼‰
- âœ… ä½†å½±å“èŒƒå›´æœ‰é™ï¼ˆä»…å½±å“è¯¥åˆ†ç‰‡çš„é”ï¼‰
- âœ… å…¶ä»–åˆ†ç‰‡çš„é”ä¸å—å½±å“

#### 12.8.3 å®é™…é¡¹ç›®ä¸­çš„æ¦‚ç‡åˆ†æ

**ä¸»ä»åˆ‡æ¢æ¦‚ç‡**ï¼š

| åœºæ™¯ | æ¦‚ç‡ | è¯´æ˜ |
|------|------|------|
| **å•èŠ‚ç‚¹æ•…éšœ** | 0.1-1% / å¹´ | ç¡¬ä»¶æ•…éšœã€ç½‘ç»œé—®é¢˜ç­‰ |
| **ä¸»ä»åˆ‡æ¢** | 0.01-0.1% / å¹´ | ä¸»èŠ‚ç‚¹æ•…éšœè§¦å‘åˆ‡æ¢ |
| **åˆ‡æ¢æ—¶ä¸¢é”** | 0.001-0.01% / å¹´ | åˆ‡æ¢æ—¶æ•°æ®æœªåŒæ­¥ |
| **å®é™…å½±å“** | æä½ | å½±å“èŒƒå›´æœ‰é™ |

**å®é™…å½±å“åˆ†æ**ï¼š

```
å‡è®¾ï¼š
- 1000 ä¸ªé”/ç§’çš„ QPS
- ä¸»ä»åˆ‡æ¢æ¦‚ç‡ï¼š0.1% / å¹´
- åˆ‡æ¢æ—¶ä¸¢é”æ¦‚ç‡ï¼š10%ï¼ˆæ•°æ®æœªåŒæ­¥ï¼‰

å¹´å½±å“ï¼š
- ä¸»ä»åˆ‡æ¢æ¬¡æ•°ï¼š0.1% Ã— 365å¤© = 0.365æ¬¡/å¹´
- ä¸¢é”æ¬¡æ•°ï¼š0.365 Ã— 10% = 0.0365æ¬¡/å¹´
- å½±å“é”æ•°é‡ï¼š0.0365 Ã— 1000 = 36.5ä¸ªé”/å¹´

ç»“è®ºï¼š
- å½±å“æå°ï¼ˆ< 0.01%ï¼‰
- å½±å“èŒƒå›´æœ‰é™ï¼ˆä»…è¯¥åˆ†ç‰‡ï¼‰
- å¤§å¤šæ•°ä¸šåŠ¡å¯ä»¥æ¥å—
```

#### 12.8.4 RedLock çš„æˆæœ¬æ”¶ç›Šåˆ†æ

**æˆæœ¬åˆ†æ**ï¼š

| æˆæœ¬é¡¹ | Cluster æ¨¡å¼ | RedLock æ¨¡å¼ | å¢åŠ  |
|--------|-------------|-------------|------|
| **Redis å®ä¾‹æ•°** | 6ä¸ªï¼ˆ3ä¸»3ä»ï¼‰ | 15-30ä¸ªï¼ˆ5-10ç»„ï¼‰ | 2.5-5å€ |
| **æœåŠ¡å™¨æˆæœ¬** | åŸºå‡† | 2.5-5å€ | é«˜ |
| **ç½‘ç»œæˆæœ¬** | åŸºå‡† | 2-3å€ | ä¸­ |
| **è¿ç»´æˆæœ¬** | åŸºå‡† | 3-5å€ | é«˜ |
| **æ€§èƒ½å»¶è¿Ÿ** | 1-5ms | 5-15ms | 3-5å€ |
| **QPS** | 100,000+ | 30,000-50,000 | ä¸‹é™50-70% |
| **å¼€å‘å¤æ‚åº¦** | ä½ | é«˜ | æ˜¾è‘—å¢åŠ  |

**æ”¶ç›Šåˆ†æ**ï¼š

| æ”¶ç›Šé¡¹ | Cluster æ¨¡å¼ | RedLock æ¨¡å¼ | æå‡ |
|--------|-------------|-------------|------|
| **é”ä¸¢å¤±æ¦‚ç‡** | 0.001-0.01% / å¹´ | < 0.0001% / å¹´ | 10-100å€ |
| **å¯é æ€§** | 99.99% | 99.999% | 0.009% |
| **ä¸€è‡´æ€§ä¿è¯** | æœ€ç»ˆä¸€è‡´æ€§ | å¼ºä¸€è‡´æ€§ï¼ˆè¿‘ä¼¼ï¼‰ | æå‡æœ‰é™ |

**æˆæœ¬æ”¶ç›Šæ¯”**ï¼š

```
æˆæœ¬å¢åŠ ï¼š2.5-5å€ï¼ˆå®ä¾‹æ•°ã€æ€§èƒ½ã€å¤æ‚åº¦ï¼‰
æ”¶ç›Šæå‡ï¼šé”ä¸¢å¤±æ¦‚ç‡ä» 0.01% é™åˆ° 0.0001%
å®é™…å½±å“ï¼šä»æ¯å¹´ 36.5 ä¸ªé”é™åˆ° 0.365 ä¸ªé”

ç»“è®ºï¼š
- æˆæœ¬å¢åŠ ï¼š250-500%
- æ”¶ç›Šæå‡ï¼šå‡å°‘ 36 ä¸ªé”/å¹´ï¼ˆå½±å“æå°ï¼‰
- æˆæœ¬æ”¶ç›Šæ¯”ï¼šä¸æˆæ­£æ¯” âŒ
```

#### 12.8.5 å®é™…é¡¹ç›®ä¸­çš„é€‰æ‹©

**å¤§å¤šæ•°å…¬å¸çš„é€‰æ‹©ï¼ˆ90%+ï¼‰**ï¼š

```
Redis Cluster æ¨¡å¼ + Redisson
  â†“
ä¸ä½¿ç”¨ RedLock
  â†“
åŸå› ï¼š
  1. ä¸»ä»åˆ‡æ¢æ¦‚ç‡æä½ï¼ˆ< 0.1% / å¹´ï¼‰
  2. å½±å“èŒƒå›´æœ‰é™ï¼ˆä»…è¯¥åˆ†ç‰‡ï¼‰
  3. RedLock æˆæœ¬é«˜ï¼ˆ2.5-5å€ï¼‰
  4. æ€§èƒ½ä¸‹é™æ˜æ˜¾ï¼ˆ50-70%ï¼‰
  5. å¤æ‚åº¦æ˜¾è‘—å¢åŠ 
  6. æ”¶ç›Šä¸æ˜æ˜¾ï¼ˆå‡å°‘å‡ åä¸ªé”/å¹´ï¼‰
```

**æ›¿ä»£æ–¹æ¡ˆ**ï¼š

1. **ä¸šåŠ¡å±‚å¹‚ç­‰æ€§ä¿è¯**ï¼ˆæ¨èï¼‰
   ```java
   // å³ä½¿é”å¤±æ•ˆï¼Œä¸šåŠ¡å±‚ä¹Ÿèƒ½ä¿è¯æ­£ç¡®æ€§
   String idempotentKey = "business:" + businessId;
   if (redis.exists(idempotentKey)) {
       return getResult(businessId);
   }
   ```

2. **é”è¿‡æœŸæ—¶é—´è®¾ç½®**
   ```java
   // è®¾ç½®åˆç†çš„é”è¿‡æœŸæ—¶é—´
   lock.tryLock(10, 30, TimeUnit.SECONDS);
   // ç­‰å¾…10ç§’ï¼Œé”å®š30ç§’
   ```

3. **ç›‘æ§å’Œå‘Šè­¦**
   ```java
   // ç›‘æ§ä¸»ä»åˆ‡æ¢äº‹ä»¶
   // å‘Šè­¦å¼‚å¸¸æƒ…å†µ
   // åŠæ—¶å¤„ç†é—®é¢˜
   ```

4. **é‡è¯•æœºåˆ¶**
   ```java
   // ä¸šåŠ¡å±‚é‡è¯•
   // å¤„ç†é”è·å–å¤±è´¥çš„æƒ…å†µ
   ```

#### 12.8.6 ä»€ä¹ˆæ—¶å€™è€ƒè™‘ RedLockï¼Ÿ

**ä»…åœ¨ä»¥ä¸‹æƒ…å†µè€ƒè™‘**ï¼š

1. **é‡‘èã€æ”¯ä»˜ç³»ç»Ÿ**
   - å¯¹ä¸€è‡´æ€§è¦æ±‚æé«˜
   - ä¸èƒ½å®¹å¿ä»»ä½•é”ä¸¢å¤±
   - å¯ä»¥æ¥å—æˆæœ¬å’Œæ€§èƒ½æŸå¤±

2. **å·²æœ‰å¤šä¸ªç‹¬ç«‹ Cluster**
   - å…¬å¸å·²æœ‰å¤šä¸ªç‹¬ç«‹çš„ Redis Cluster
   - å¯ä»¥å¤ç”¨ç°æœ‰åŸºç¡€è®¾æ–½
   - æˆæœ¬å¢åŠ ä¸æ˜æ˜¾

3. **ç‰¹æ®Šä¸šåŠ¡éœ€æ±‚**
   - ä¸šåŠ¡å¯¹é”çš„å¯é æ€§è¦æ±‚æé«˜
   - ä¸»ä»åˆ‡æ¢é¢‘ç¹ï¼ˆå¼‚å¸¸æƒ…å†µï¼‰
   - æ— æ³•æ¥å—é”ä¸¢å¤±çš„é£é™©

**ä½†å³ä½¿åœ¨è¿™äº›åœºæ™¯ï¼Œæ›´æ¨è**ï¼š
- ä½¿ç”¨ ZooKeeperï¼ˆCuratorï¼‰
- æˆæœ¬æ›´ä½ã€å¯é æ€§æ›´é«˜

#### 12.8.7 æ€»ç»“å’Œå»ºè®®

**æ ¸å¿ƒç»“è®º**ï¼š

1. **Redis Cluster æ¨¡å¼ä¸‹ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹åˆ†å¸ƒå¼é”å·²ç»è¶³å¤Ÿ**
   - âœ… ä¸»ä»åˆ‡æ¢æ¦‚ç‡æä½ï¼ˆ< 0.1% / å¹´ï¼‰
   - âœ… å½±å“èŒƒå›´æœ‰é™ï¼ˆä»…è¯¥åˆ†ç‰‡ï¼‰
   - âœ… å¤§å¤šæ•°ä¸šåŠ¡å¯ä»¥æ¥å—

2. **Redis Cluster ä¸èƒ½ç”¨äº RedLock**
   - âŒ Cluster çš„ master æ˜¯æ•°æ®åˆ†ç‰‡ï¼Œä¸æ˜¯ç‹¬ç«‹å®ä¾‹
   - âŒ åŒä¸€ä¸ª key åªä¼šå­˜å‚¨åœ¨ä¸€ä¸ª master ä¸Š
   - âŒ æ— æ³•æ»¡è¶³ RedLock çš„è¦æ±‚ï¼ˆéœ€è¦å¤šä¸ªå®ä¾‹éƒ½å­˜å‚¨ï¼‰

3. **RedLock éœ€è¦é¢å¤–éƒ¨ç½²ç‹¬ç«‹çš„ Redis å®ä¾‹**
   - âš ï¸ éœ€è¦ 3-5 ä¸ªç‹¬ç«‹çš„ Redis å®ä¾‹ï¼ˆå•æœºæˆ–ä¸»ä»ï¼‰
   - âš ï¸ ä¸èƒ½ä½¿ç”¨ Cluster çš„ master èŠ‚ç‚¹
   - ğŸ’° æˆæœ¬å¢åŠ  2å€ï¼ˆå¦‚æœå·²æœ‰ Clusterï¼‰

4. **RedLock çš„æˆæœ¬æ”¶ç›Šä¸æˆæ­£æ¯”**
   - âŒ æˆæœ¬å¢åŠ  2.5-5å€ï¼ˆé¢å¤–éƒ¨ç½²å®ä¾‹ï¼‰
   - âŒ æ€§èƒ½ä¸‹é™ 50-70%
   - âŒ å¤æ‚åº¦æ˜¾è‘—å¢åŠ 
   - âœ… æ”¶ç›Šæœ‰é™ï¼ˆå‡å°‘å‡ åä¸ªé”/å¹´ï¼‰

5. **æ›´å¥½çš„é€‰æ‹©**
   - âœ… ä¸šåŠ¡å±‚å¹‚ç­‰æ€§ä¿è¯ï¼ˆæ¨èï¼‰
   - âœ… åˆç†çš„é”è¿‡æœŸæ—¶é—´
   - âœ… ç›‘æ§å’Œå‘Šè­¦
   - âœ… é‡è¯•æœºåˆ¶

**å®é™…å»ºè®®**ï¼š

| åœºæ™¯ | æ¨èæ–¹æ¡ˆ | è¯´æ˜ |
|------|----------|------|
| **ä¸€èˆ¬ä¸šåŠ¡** | Redis Cluster + Redisson | 90% åœºæ™¯ |
| **é‡è¦ä¸šåŠ¡** | Redis Cluster + Redisson + å¹‚ç­‰æ€§ | 8% åœºæ™¯ |
| **é‡‘èæ”¯ä»˜** | ZooKeeperï¼ˆCuratorï¼‰ | 2% åœºæ™¯ |
| **ä¸æ¨è** | RedLock | æˆæœ¬æ”¶ç›Šä¸æˆæ­£æ¯” |

**å…³é”®é—®é¢˜çš„ç­”æ¡ˆ**ï¼š

**Q: Redis Cluster æœ‰å¤šä¸ª masterï¼Œèƒ½å¦ç›´æ¥ç”¨äº RedLockï¼Ÿ**

A: âŒ ä¸èƒ½ï¼åŸå› ï¼š
- Redis Cluster çš„ master æ˜¯æ•°æ®åˆ†ç‰‡ï¼Œä¸æ˜¯ç‹¬ç«‹å®ä¾‹
- åŒä¸€ä¸ª key åªä¼šå­˜å‚¨åœ¨ä¸€ä¸ª master ä¸Šï¼ˆæ ¹æ® slot åˆ†é…ï¼‰
- RedLock éœ€è¦åŒä¸€ä¸ª key åœ¨å¤šä¸ªç‹¬ç«‹å®ä¾‹ä¸Šéƒ½å­˜å‚¨
- å¦‚æœè¦ç”¨ RedLockï¼Œéœ€è¦é¢å¤–éƒ¨ç½² 3-5 ä¸ªç‹¬ç«‹çš„ Redis å®ä¾‹

**Q: å¦‚æœå·²æœ‰ Redis Clusterï¼Œè¿˜éœ€è¦éƒ¨ç½² RedLock å—ï¼Ÿ**

A: âŒ å¤§å¤šæ•°æƒ…å†µä¸‹ä¸éœ€è¦ï¼åŸå› ï¼š
- éœ€è¦é¢å¤–éƒ¨ç½²ç‹¬ç«‹çš„ Redis å®ä¾‹ï¼ˆæˆæœ¬å¢åŠ  2å€ï¼‰
- æ€§èƒ½ä¸‹é™ 50-70%
- æ”¶ç›Šæœ‰é™ï¼ˆå‡å°‘å‡ åä¸ªé”/å¹´ï¼‰
- æ›´å¥½çš„é€‰æ‹©æ˜¯ä¸šåŠ¡å±‚å¹‚ç­‰æ€§ä¿è¯

**æœ€ç»ˆå»ºè®®**ï¼š

- **é»˜è®¤é€‰æ‹©**ï¼šRedis Cluster + Redisson + ä¸šåŠ¡å¹‚ç­‰æ€§
- **ç‰¹æ®Šåœºæ™¯**ï¼šZooKeeperï¼ˆCuratorï¼‰
- **ä¸æ¨è**ï¼šRedLockï¼ˆé™¤éç‰¹æ®Šéœ€æ±‚ä¸”æ— æ³•ä½¿ç”¨ ZooKeeperï¼‰
- **å…³é”®ç‚¹**ï¼šRedis Cluster çš„ master ä¸èƒ½ç”¨äº RedLockï¼Œéœ€è¦é¢å¤–éƒ¨ç½²ç‹¬ç«‹å®ä¾‹

---

## 13. æ€»ç»“

### 12.1 æ ¸å¿ƒå¯¹æ¯”

| ç»´åº¦ | Redisson | Apache Curator | å…³é”®å·®å¼‚ |
|------|----------|----------------|----------|
| **æ€§èƒ½** | æé«˜ï¼ˆ100k+ QPSï¼‰ | ä¸­ç­‰ï¼ˆ5k-10k QPSï¼‰ | Redis å†…å­˜æ“ä½œ vs ZooKeeper ç½‘ç»œ+ç£ç›˜ |
| **ä¸€è‡´æ€§** | æœ€ç»ˆä¸€è‡´æ€§ï¼ˆAPï¼‰ | å¼ºä¸€è‡´æ€§ï¼ˆCPï¼‰ | Redis AP vs ZooKeeper CP |
| **å¯é æ€§** | ä¸­ç­‰ï¼ˆä¸»ä»åˆ‡æ¢å¯èƒ½ä¸¢é”ï¼‰ | æé«˜ï¼ˆå¼ºä¸€è‡´æ€§ä¿è¯ï¼‰ | Redis æ•…éšœè½¬ç§» vs ZooKeeper ä¸€è‡´æ€§åè®® |
| **æ˜“ç”¨æ€§** | æé«˜ï¼ˆAPI ç®€æ´ï¼‰ | é«˜ï¼ˆAPI ç®€æ´ï¼‰ | éƒ½å¾ˆå¥½ï¼ŒRedisson ç•¥ä¼˜ |
| **æˆæœ¬** | ä½ï¼ˆå¤ç”¨ Redisï¼‰ | ä¸­ç­‰ï¼ˆéœ€è¦ ZooKeeperï¼‰ | Redis æ›´å¸¸è§ |

### 11.2 é€‰æ‹©åŸåˆ™

1. **æ€§èƒ½ä¼˜å…ˆ** â†’ Redisson
2. **ä¸€è‡´æ€§ä¼˜å…ˆ** â†’ Apache Curator
3. **å·²æœ‰åŸºç¡€è®¾æ–½** â†’ ä¼˜å…ˆä½¿ç”¨å·²æœ‰çš„
4. **ä¸šåŠ¡åœºæ™¯** â†’ æ ¹æ®å…·ä½“éœ€æ±‚é€‰æ‹©

### 11.3 æœ€ç»ˆå»ºè®®

- **å¤§å¤šæ•°åœºæ™¯**ï¼šé€‰æ‹© **Redisson**ï¼ˆæ€§èƒ½å¥½ã€ç®€å•ã€æˆæœ¬ä½ï¼‰
- **ç‰¹æ®Šåœºæ™¯**ï¼šé€‰æ‹© **Apache Curator**ï¼ˆå¼ºä¸€è‡´æ€§ã€é•¿æ—¶é—´é”ã€å…¬å¹³é”ï¼‰

**æ²¡æœ‰ç»å¯¹çš„å¥½åï¼Œåªæœ‰é€‚åˆä¸é€‚åˆï¼**

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2024å¹´  
**ä½œè€…**ï¼šZookeeper-study é¡¹ç›®ç»„

